<!-- chat.html -->

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>LLM Chat</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">


        <!--CSS Goes Here-->
        <style>

            body {
                font-family: 'Inter', sans-serif;
            }

            .glassmorphism {
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(8px);
                border-radius: 10px;
                border: 1px solid rgba(255, 255, 255, 0.18);
                box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            }

            .sidenav {
                height: 100%;
                width: 0;
                position: fixed;
                z-index: 1;
                top: 0;
                left: -2px;
                background-color: #111;
                transition: 0.5s;
                overflow-x: hidden;
                overflow-y: auto;
                padding-top: 10px;
                border-radius: 10px;
                margin-top: 5px;
            }

            .nav-item {
                padding: 8px 8px 8px 32px;
                text-decoration: none;
                font-size: 18px;
                color: #818181;
                display: block;
                transition: 0.3s;
                cursor: pointer;
            }

            .sidenav a {
                padding: 8px 8px 8px 32px;
                text-decoration: none;
                font-size: 25px;
                color: #818181;
                display: block;
                transition: 0.3s;
            }

            .nav-item:hover {
                background-color: #555;
            }

            .sidenav a:hover {
                color: #f1f1f1;
            }

            .sidenav .sortbtn:hover {
                color: #f1f1f1;
            }

            .sortbtn {
                padding: 8px 8px 8px 32px;
                text-decoration: none;
                font-size: 18px;
                color: #818181;
                display: block;
                transition: 0.3s;
                position: absolute;
            }

            .sidenav .closebtn {
                position: absolute;
                top: 0;
                right: 25px;
                font-size: 36px;
                margin-left: 50px;
            }

            .sidenav-content {
                overflow-y: auto;
                position: absolute;
                top: 69px;
                left: 0;
                right: 0;
                bottom: 0;
            }

            .chat-container {
                display: flex;
                flex-direction: column; /* Stack children vertically */
                justify-content: space-between; /* Space between chat area and input area */
                flex-grow: 1;
                z-index: 0;
                height: 95vh;
            }

            .chat-area {
                position: relative;
                flex: 1;
                overflow-y: auto; /* Add a scrollbar if content overflows */
                padding: 1rem;
                border-bottom: 1px solid #383d3f;
                font-size: 16px; /* Adjust as needed */
                color: #333; /* Dark gray color for better readability */
                margin-top: 30px;
            }

            .input-area {
                /* Any specific styles you want for the input area */
                padding: 1rem;
                background-color: #f5f5f5;
            }

            .form-control {
                background-color: #181a1b;
                color: #d1cdc7;
                border: solid #383d3f;
                border-width: thin;
            }

            .input-area .form-control {
                margin-right: 0.5rem;
            }

            .form-control::placeholder {
                color: #464b4d !important;
                font-weight:500;
            }

            .user-message {
                font-weight: 500; /* Medium thickness */
                margin-bottom: 0.5rem; /* Spacing between messages */
                background-color: darkslategray;
                padding: 0.5rem;
                border-radius: 1rem;
                color: white;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            }

            .llm-response {
                font-weight: 400; /* Was 500 */
                margin-bottom: 0.5rem; /* Spacing between messages */
                background-color: #1e2022;
                color: #e8e6e3; 
                padding: 0.5rem;
                border-radius: 1rem;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                border: 1px solid #3A3E41;
            }

            .scroll-down-btn {
                position: absolute;
                bottom: 80px;
                right: 20px;
                cursor: pointer;
                font-size: 24px;
                background-color: transparent;

                /* Additional styling */
                border: none;
                outline: none;
                color: #6bb3ff;

                /* Optional padding */
                padding: 5px;

                /* Effect for hover*/
                transition: color 0.3s ease;

                /* Adjust alignment if the icon is not centered */
                text-align: center;
                line-height: 1;
            }

            /* Style for hover effect (optional) */
            .scroll-down-btn:hover {
                color: #327DFF;
            }

            .upload-file-btn {
                margin-right: 7px; /* adjust as needed */
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .loader {
                margin: 60px auto;
                font-size: 10px;
                width: 50px;
                height: 50px;
                position: relative;
                text-indent: -9999em;
                border-top: 1.1em solid rgba(255, 255, 255, 0.2);
                border-right: 1.1em solid rgba(255, 255, 255, 0.2);
                border-bottom: 1.1em solid rgba(255, 255, 255, 0.2);
                border-left: 1.1em solid #ffffff;
                transform: translateZ(0);
                animation: spin 0.7s infinite linear;
                border-radius: 50%;
            }

            .cell-loader {
                border: 2px solid #f3f3f3;
                border-top: 2px solid #3498db;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                animation: spin 1s linear infinite;
                display: inline-block;
            }

            .waiting {
                color: #f39c12;
            }

            .success {
                color: #2ecc71;
            }

            .failure {
                color: #e74c3c;
            }

            #overlay {
                /* ... your existing styles ... */
                backdrop-filter: blur(10px);
                background-color: rgb(255, 255, 255, 0.7); /* This will add a white translucent background, adjust opacity as needed */
            }

            .llm-wrapper {
                position: relative;
                margin-bottom: 2rem;
            }

            .response-and-viewer-container {
                display: flex;
                margin-bottom: 100px;
            }

            .pdf-viewer {
                flex: 1;
                padding: 10px;
                padding-top: 0px;
                transform: translateY(-15px);
                box-sizing: border-box;
            }

            .llm-wrapper {
                flex: 1;
                padding: 10px;
                box-sizing: border-box;
            }


            .star-rating {
                position: absolute;
                right: 0;
                display: flex;
                justify-content: flex-end;
                gap: 4px;
                padding: 5px 10px; /* Spacing inside the star-rating container */
                border: 1px solid #ccc; /* Border around the star-rating */
                border-radius: 15px; /* Rounded border */
                background-color: #181A1B; /* White background */
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Optional: adds a subtle shadow */
            }

            .fa-star {
                cursor: pointer;
                color: #ccc; /* Color of non-rated stars. #ccc: light-gray */
                font-size: 18px;
                transition: color 0.3s; /* Smooth transition for filling stars */
            }

            .fas.fa-star {
                color: #ffa500; /* Color of rated stars: Yellow */
            }

            .header-container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 15px;
                height: 5vh;
            }

            .header-right {
                display: flex;
                align-items: center;
            }

            .header-text {
                display: flex;
                flex-direction: column; /* Stack h3 and h4 vertically */
                align-items: center;    /* Center the text horizontally */
                flex-grow: 1;           /* Allow the container to take up available space */
                display: none;
            }

            .info-container {
                margin-right: 15px;
            }

            .info-container .info-box {
                position: absolute;
                right: 100%;
                margin-right: 10px;
                top: 0;
                width: max-content;
                max-width: 345px;
                background-color: rgba(23, 26, 27, 0.7); /*Alpha adjusted for transparency*/
                color: #D1CDC7;
                box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); /*Match the glassmorphism box shadow*/
                z-index: 100;
                padding: 10px;
                border-radius: 10px; /*Match the glassmorphism border radius*/
                border: 1px solid rgba(255, 255, 255, 0.18); /*Match the glassmorphism border*/
            }

            .info-container .info-box::before {
                content: '';
                position: absolute;
                top: 18px;
                right: 1px;
                margin-left: -5px;
                border-width: 5px;
                border-style: solid;
                border-color: transparent transparent transparent black;
                z-index: 101;
            }

            /* Style your h3 and h4 elements inside the info-box as desired */
            .info-container .info-box h3,
            .info-container .info-box h4 {
                margin: 0;
                text-align: center;
            }

            .info-container .info-box h3 {
                font-size: medium;
            }

            .info-container .info-box h4 {
                margin-top: 10px;
                font-size: small;
            }

            .header-logo {
                display: flex;
                flex-direction: column; /* Stack h3 and h4 vertically */
                align-items: center;    /* Center the text horizontally */
                flex-grow: 1;           /* Allow the container to take up available space */
                height: 100%;
                width: auto;
            }

            #main_logo {
                max-width: 250px;
                height: auto;
                width: 100%;
            }

            .modal-content {
                background-color: #181A1B;
                color: #e8e6e3;
                border: 1px solid #3A3E41;
            }

            .modal-header{
                border: 1px solid #3A3E41;
            }

            .modal-footer {
                border: 1px solid #3A3E41;
            }

            .modal-selection-radios {
                display: flex; /* Uses flexbox to lay out child elements*/
                justify-content: space-between; /* space out children evenly */
                width: 100%;
            }

            .modal-selection-radios label {
                flex: 1;    /* Allow each label to grow and take up equal space*/
            }

            .custom-modal-width {
                max-width: 75%;
            }

            .api_form .form-group {
                display: flex;
                margin-bottom: 10px;
            }

            .api_form .form-group label {
                flex: 0 0 auto; /*prevent label from growing*/
                margin-right: 10px; /*space between label and input*/
                white-space: nowrap;    /*prevents label from wrapping*/
            }

            .api_form .form-group input[type="text"] {
                flex: 1 1 auto; /*Allow the input to grow and fill available space*/
                width: 0;   /*trick to ensure flex-grow works!*/
            }

            .modal-selects {
                width: 100%;
            }

            /* Targeting all button elements within .modal-footer and .input-area */
            .modal-footer button,
            .input-area button,
            .input-area input[type="button"],
            .input-area input[type="submit"] {
            background-color: #343A40; /* Example: Set a common background color */
            color: #ffffff; /* Example: Set a common text color */
            border: none; /* Example: Remove border */
            border-radius: 5px; /* Example: Set rounded corners */
            cursor: pointer; /* Change the cursor on hover */
            }

            /* Common hover effect for all buttons */
            .modal-footer button:hover,
            .input-area button:hover,
            .input-area input[type="button"]:hover,
            .input-area input[type="submit"]:hover {
            background-color: #282d33; /* Darker shade on hover */
            }

            .btn-primary {
                background-color: darkslategray;
                border-width: 0;
            }

            .btn-primary:hover {
                background-color: darkslateblue;
            }

            .btn-outline-secondary {
                background-color: white;
                color: black;
                border-style: double;
                border-color: black;
            }

            .btn-outline-secondary:hover {
                background-color: darkorange;
            }


            #saveChangesButton {
                background-color: darkslategray;
                border-width: 0;
            }

            #saveChangesButton:hover {
                background-color: darkslateblue;
            }

            .llm-adv-set-toggle {
                text-decoration: none;
                color: white;
                font-weight: 500;
            }

            .llm-adv-set-toggle:hover {
                color: black;
            }

            #docs_loaded_details_table {
                width: 100%;
                table-layout: fixed;
            }

            #docs_loaded_details_table th, #docs_loaded_details_table td {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            #google_drive_files_tables {
                width: 100%;
                table-layout: fixed;
            }

            #google_drive_files_tables th, #google_drive_files_tables td {
                word-wrap: break-word;
                overflow-wrap: break-word;
                text-align: center;
            }

            #googleDriveSyncAction {
                margin-top: 10px;
                float: left;
            }

            .checkbox-cell {
                text-align: center;
            }

            .checkbox-cell input[type="checkbox"] {
                margin: 0;
                vertical-align: middle;
            }

            table {
                border-collapse: collapse;
                width: 100%;
            }

            th, td {
                padding: 7px;
                text-align: left;
                border-bottom: 1px solid #DDD;
                border-top: 1px solid #DDD;
            }

            tr:hover {
                background-color: darkslategray;
            }

            .settings-requiring-restart-container {
                border: 1px solid #3A3E41;
                padding: 10px;
                position: relative;
                border-radius: 5px;
            }

            .restart-settings-group {
                padding-bottom: 10px;
            }

            .hf-select-settings-divs-group {
                display: flex;
                align-items: center;
            }

            .hf-select-settings-labels-group {
                margin-right: 10px;
            }

            .restart-warning {
                position: absolute;
                right: 10px;
                bottom: 10px;
                padding: 5px;
                border-radius: 5px;
                display: flex;
                align-items: center;
                font-size: 16px;    /*Adjusts the size of icon & text*/
                font-weight: 500;
            }

            .restart-warning i {
                margin-right: 5px;
                color: #ffcc00;
            }

            a.list-group-item.list-group-item-action {
                background-color: #181A1B;
                border: 1px solid #3A3E41;
                color: #D1CDC7;
            }

            a.list-group-item.list-group-item-action:hover {
                background-color: darkslategray
            }

            a.list-group-item.list-group-item-action.active {
                background-color: darkslategray;
                border: 1px solid darkslategray;
                color: #D1CDC7;
            }

            #processingQnS {
                color: #D1CDC7;
            }

            #processingQ {
                color: #D1CDC7;
            }

            /*SCROLLBAR STYLING - For WebKit-based browsers (Chrome, Safari, newer versions of Edge):*/
            /* This styles the scrollbar track (the part the thumb slides along) */
            ::-webkit-scrollbar-track {
                background: #212324; /* Light grey track background */
            }

            /* This styles the scrollbar thumb (the part that's draggable) */
            ::-webkit-scrollbar-thumb {
                background: #464A4D; /* Grey thumb */
            }

            /* This styles the scrollbar thumb on hover */
            ::-webkit-scrollbar-thumb:hover {
                background: #575E62; /* Darker grey on hover */
            }

            /* This styles the overall scrollbar (width, etc.) */
            /* ::-webkit-scrollbar {
                width: 10px; /* Width of the scrollbar
            } */

            /*SCROLLBAR STYLING - For Firefox:*/
            /* The syntax is scrollbar-color: <thumb color> <track color>; */
            body {
                scrollbar-color: #464A4D #212324; 
                /*scrollbar-width: thin; /* Can be "auto", "thin", or "none" */
            }

            .thumbnail-icon {
                font-size: 100px;
                cursor: pointer;
            }

            .image-gallery-modal {
                display: none;
                position: fixed;
                z-index: 1050;  /* Bootstrap modals use z-index of 1050, so this ensures it is above */
                padding-top: 100px;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0, 0, 0, 0.9);
            }

            .image-gallery-content {
                position: relative;
                margin: auto;
                padding: 0;
                width: 80%;
                max-width: 1200px;
                text-align: center;
            }

            .image-gallery-close {
                position: absolute;
                top: 10px;
                right: 25px;
                color: white;
                font-size: 35px;
                font-weight: bold;
                cursor: pointer;
            }

            .image-gallery-close:hover,
            .image-gallery-close:focus {
                color: #999;
                text-decoration: none;
                cursor: pointer;
            }

            .gallery-thumbnail {
                margin: 10px;
                width: 100%;
                height: 350px;
                cursor: grabbing;
            }

            .pdf-viewer-container {
                width: 50%;
                height: 600px;
            }

            .tab-buttons {
                overflow: hidden;
                border: 1px solid #3A3E41; /*darkslategray;*/
                background-color: transparent;
            }

            .tab-button {
                background-color: #282828;
                color: white;
                float: left;
                border: 2px solid black;
                border-radius: 3px;
                outline: none;
                cursor: pointer;
                padding: 14px 16px;
                transition: 0.3s;
            }

            .tab-button:hover {
                background-color: #ddd;
            }

            .tab-button.active {
                background-color: white;
                color: black;
            }

            .tab-content {
                display: none;
                padding: 6px 12px;
                border: 1px solid #3A3E41; /*darkslategray;*/
                border-top: none;
            }

            .hf-waitress-llm-custom-select {
                position: relative;
                width: 100%;
            }

            .hf-waitress-llm-custom-select-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                border: 1px solid black;
                color: black;
                background-color: white;
                border-radius: 3px;
                cursor: pointer;
            }

            .hf-waitress-llm-custom-dropdown-content {
                display: none;
                position: absolute;
                background-color: #f9f9f9;
                box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
                z-index: 1;
                width: 100%;
            }

            .hf-waitress-llm-custom-dropdown-content.show {
                display: block;
            }

            .hf-waitress-llm-custom-dropdown-search-and-sort-header {
                display: flex;
                padding: 10px;
            }

            .hf-waitress-llm-custom-dropdown-sort-btn {
                width: 30%;
                margin-right: 5px;
                color: white;
                background-color: darkslategray;
            }

            .hf-waitress-llm-custom-dropdown-search-input {
                width: 70%;
            }
            
            .hf-waitress-llm-custom-dropdown-add-btn, .hf-waitress-llm-custom-dropdown-add-input {
                width: 100%;
                padding: 5px;
                margin-bottom: 5px;
            }

            .hf-waitress-llm-custom-dropdown-add-btn {
                color: white;
                background-color: darkslategray;
            }

            .hf-waitress-llm-custom-dropdown-item {
                display: flex;
                justify-content: space-between;
                padding: 10px;
                border-bottom: 1px solid #eee;
                color: black;
            }

            .hf-waitress-llm-custom-dropdown-item:hover {
                background-color: #f1f1f1;
            }
            
            .hf-waitress-llm-custom-dropdown-delete-btn {
                cursor: pointer;
            }

            .nav-toggle {
                display: flex;
                align-items: center;
                cursor: pointer;
            }

            .app-title {
                margin-left: 11px;
                color: white;
                font-size: 31px;
                font-weight: 700;
                font-style: italic;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
                letter-spacing: 5px;
                user-select: none;
            }

            .app-title span {
                display: inline-block;
                transition: transform 0.3s ease;
            }

            .app-title:hover span {
                animation: bounce 0.6s;
            }

            @keyframes bounce {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-10px); }
            }

        </style>

    </head>

    <body style="background-color: #181a1b;">
        
        <div class="header-container">
            
            <div class="nav-toggle" onclick="openNav()">
                <span style="font-size:30px; cursor:pointer; color: #D1CDC7;">&#9776;</span>
                <div class="app-title">
                    <span>L</span><span>A</span><span>R</span><span>S</span>
                </div>
            </div>

            <div class="header-right">
                <div class="info-container" style="cursor: pointer; position: relative; font-size: 30px; color: #D1CDC7;">
                    <i class="fa-solid fa-circle-info info-icon" onclick="toggleInfo()"></i>
                    <div class="info-box glassmorphism" id="info_box" style="display: none;">
                        <h3 style="display: none;" id="model_header" class="fa-solid fa-brain"></h3>
                        <h4 style="display: none;" id="old_model_header" class="fa-solid fa-brain"></h4>
                    </div>
                </div>
                <span style="font-size:30px; cursor:pointer; color: #D1CDC7;" id="settings_gear" data-bs-toggle="modal" data-bs-target="#settingsModal"><i class="fa-solid fa-gear"></i></span>    
            </div>
            
        </div>
        <!--
            NOTES ON ABOVE:
            1) data-bs-toggle="modal":
                This attribute tells Bootstrap that the element (e.g., a button) should act as a trigger for a modal.
                When the element with this attribute is clicked, it will toggle (in this case, open) the modal specified by the associated data-bs-target attribute.
                
            2)data-bs-target="#settingsModal":
                This attribute specifies the HTML element that should be toggled (opened) when the trigger is clicked.
                The value is a CSS selector pointing to the desired modal element.
                The # symbol in #settingsModal indicates that it's an ID selector. In other words, this attribute is pointing to an element with the id="settingsModal" in the HTML. 
                It means that somewhere in your HTML, there should be a modal with the ID of settingsModal that will be opened when this trigger is clicked.
        -->


        <div class="sidenav glassmorphism" id="sidenav">
            <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
            <a href="javascript:void(0)" class="sortbtn" onclick="sortNavItems()">&#8597;</a>
            <div class="sidenav-content" id="sidenav-content">
                <a href="#" id="dynamicChatLink" class="fas fa-plus" style="font-size: 18px;"> New Chat</a>
            </div>
        </div>

        <div class="chat-container">
           
            <div class="chat-area" id="chat-area">
                <!-- ###Messages appended here -->
            </div>

            <i class="fa-solid fa-circle-down scroll-down-btn" id="scrollDownButton"></i>
            
            <h3 id="processingQ" style="display: none;">Thinking...</h3>
            
            <h3 id="processingQnS" style="display: none;"></h3>
            
            <div class="input-area d-flex justify-content-center align-items-center" id="input-area" style="background-color: #1e2021;">
                <textarea rows="1" cols="50" class="form-control" id="user-input" onclick="closeNav()" placeholder="Type your prompts here..."></textarea>
                <input type="file" name="file" id="fileInput" style="display:none;">
                <button type="button" id="fileInputButton" class="btn btn-primary upload-file-btn" onclick="closeNav(); document.getElementById('fileInput').click();"><i class="fas fa-paperclip"></i></button>
                <button class="btn btn-primary" id="sendButton" onclick="closeNav(); requestFormattedPrompt()">Send</button>
            </div>
            
        </div>

        <div class="loader2" id="overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgb(250,250,250,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: black; font-size: 24px; font-weight: 500;">
                Processing New Document...
            </div>
        </div>

        <div id="UploadingLlmOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgb(250,250,250,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: black; font-size: 24px; font-weight: 500;">
                Uploading LLM to 'models' directory...
                <div id="uploadProgress" style="display: none;">
                    <p>Upload Progress: <span id="progressPercentage">0%</span></p>
                </div>
            </div>
        </div>

        <div id="ModelAndDBLoading" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgb(250,250,250,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: black; font-size: 24px; font-weight: 500;">
                Loading Core Backend...
            </div>
        </div>

        <div id="ReadyToChat" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgb(250,250,250,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: black; font-size: 24px; font-weight: 500;">
                All loaded up & ready to chat!
            </div>
        </div>

        <div id="SavingHfWaitressSettings" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgb(250,250,250,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: black; font-size: 24px; font-weight: 500;">
                Saving HF-Waitress Server Settings...
            </div>
        </div>


        <!-- Settings Popup - Bootstrap Modal -->
        <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl custom-modal-width">
                <div class="modal-content">
                    
                    <div class="modal-header">
                        <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body">

                        <!--To ensure content is displayed side-by-side-->
                        <div class="d-flex">

                            <!--Options on the left-->
                            <div class="list-group w-25 me-3" id="modal-left-options-list">
                                <a href="#" class="list-group-item list-group-item-action active" data-content="option1">LLM Selection</a>
                                <a href="#" class="list-group-item list-group-item-action" data-content="option2">VectorDB & Embedding Models</a>
                                <a href="#" class="list-group-item list-group-item-action" data-content="option3">System Prompt</a>
                                <a href="#" class="list-group-item list-group-item-action" data-content="option4">RAG Options</a>
                                <a href="#" class="list-group-item list-group-item-action" data-content="option5">OCR Options</a>
                                <a href="#" class="list-group-item list-group-item-action" data-content="option6">Google Drive Loader</a>
                                <a href="#" class="list-group-item list-group-item-action" data-content="option7">Additional Settings</a>
                                <!--Add as Needed-->
                            </div>

                            <!--Details on the right-->
                            <div class="w-75">

                                <div id="option1">
                                    <!--Option 1 Content-->
                                    <h5>LLM Selection: Options for Local-Inferencing & APIs</h5>

                                    <br>
                                    
                                    <div id="llm_type_choice" class="modal-selection-radios">
                                        <label for="local_llm_radio_button" style="flex: 1;">
                                            <input type="radio" id="local_llm_radio_button" name="use_local_or_api_llm" value="local"> Local-LLMs
                                        </label>
                                        <label for="api_llm_radio_button" style="flex: 1;">
                                            <input type="radio" id="api_llm_radio_button" name="use_local_or_api_llm" value="api"> APIs
                                        </label>
                                    </div>

                                    <br>

                                    <div id="localLlmDiv" style="display: none;">

                                        <div id="local_llm_server_select_div">
                                            <label style="margin-bottom: 3px;">Select an LLM Server:</label>
                                            <br>
                                            <select class="modal-selects" name="local_llm_server_selector" id="local_llm_server_select_dropdown">
                                                <option value="hf-waitress">HF-Waitress</option>
                                                <option value="llama-cpp">llama.cpp</option>
                                                <!-- Add future servers here!-->
                                            </select>
                                        </div>

                                        <div class="local-llm-server-status-indicator">
                                            <span id="local_llm_server_status_indicator_text" style="color: red; font-weight: 500;"><i class="fa-solid fa-circle"></i> Server Offline</span>
                                        </div>

                                        <br>

                                        <div id="hf_waitress_div" style="display: none;">
                                        
                                            <!-- <div id="localHfLlmSelection">
                                                <label style="margin-bottom: 3px;">Select a local LLM:</label>
                                                <br>
                                                <select class="modal-selects" name="hf_model_choice" id="hfModelDropdown">
                                                    
                                                </select>
                                            </div>

                                            <br> -->

                                            <div class="hf-waitress-llm-custom-select" id="hf-waitress-llm-custom-select">
                                                <label style="margin-bottom: 3px;">Select a local LLM:</label>
                                                <br>
                                                <div class="hf-waitress-llm-custom-select-header" id="hf-waitress-llm-custom-select-header">
                                                    <span class="hf-waitress-llm-custom-dropdown-selected-value" id="hf-waitress-llm-custom-dropdown-selected-value">Select an item</span>
                                                    <span class="hf-waitress-llm-custom-dropdown-arrow" id="hf-waitress-llm-custom-dropdown-arrow">â–¼</span>
                                                </div>
                                                <div class="hf-waitress-llm-custom-dropdown-content" id="hf-waitress-llm-custom-dropdown-content">
                                                    <div class="hf-waitress-llm-custom-dropdown-search-and-sort-header">
                                                        <button class="hf-waitress-llm-custom-dropdown-sort-btn" id="hf-waitress-llm-custom-dropdown-sort-btn" onclick="reverseSortCustomDropdown()">Sort</button>
                                                        <input type="text" class="hf-waitress-llm-custom-dropdown-search-input" id="hf-waitress-llm-custom-dropdown-search-input" placeholder="Search...">
                                                    </div>
                                                    <div class="hf-waitress-llm-custom-dropdown-add-item-container">
                                                        <button class="hf-waitress-llm-custom-dropdown-add-btn" id="hf-waitress-llm-custom-dropdown-add-btn">+ Add</button>
                                                        <input type="text" class="hf-waitress-llm-custom-dropdown-add-input" id="hf-waitress-llm-custom-dropdown-add-input" style="display: none;" placeholder="Enter new model id...">
                                                    </div>
                                                    <div class="hf-waitress-llm-custom-dropdown-items-list" id="hf-waitress-llm-custom-dropdown-items-list"></div>
                                                </div>
                                            </div>

                                            <br>

                                            <div id="hf_waitress_is_awq">
                                                <label class="hf-select-settings-labels-group">Activation-aware Weight Quantized (AWQ) Model? (--awq):</label>
                                                <input type="radio" id="hf_waitress_is_awq_yes" name="hf_use_awq" value="y" style="margin-left: 7px;"> Yes
                                                <input type="radio" id="hf_waitress_is_awq_no" name="hf_use_awq" value="n" style="margin-left: 7px;"> No (Default)
                                            </div>

                                            <br>

                                            <div id="hf_waitress_trust_remote_code">
                                                <label class="hf-select-settings-labels-group">Trust Remote Code (--trust_remote_code):</label>
                                                <input type="radio" id="hf_waitress_trust_remote_code_yes" name="hf_trust_remote" value="y" style="margin-left: 7px;"> Yes (Default)
                                                <input type="radio" id="hf_waitress_trust_remote_code_no" name="hf_trust_remote" value="n" style="margin-left: 7px;"> No
                                            </div>

                                            <br>

                                            <!--Advanced Settings Section Begins-->
                                            <a href="#" class="btn btn-link btn-primary llm-adv-set-toggle" id="advancedHfLlmSettingsToggle" data-bs-toggle="collapse" data-bs-target="#advancedHfLlmSettings" aria-expanded="false" aria-controls="advancedHfLlmSettings" style="display: inline-block;">
                                                Advanced Settings >>>
                                            </a>

                                            <div class="collapse" id="advancedHfLlmSettings">
                                                <div class="card card-body" style="background-color: #181A1B; border: none;">
                                                    
                                                    <!-- Add options here | TODO: style "Advanced Settings" button! -->
        
                                                    <button class="btn btn-primary" type="button" id="resetHfLlmAdvancedDefaults">Reset to Defaults</button>
        
                                                    <br>

                                                    <div class="form-group" style="display: flex; align-items: center;">
                                                        <input type="checkbox" id="update_hf_access_token" name="update_hf_access_token" style="margin-right: 10px;">
                                                        <label for="update_hf_access_token" style="margin-right: 20px;">Update HF Access Token for Gated Models</label>
                                                        <input type="text" id="hf_access_token" name="hf_access_token" style="width: 100%;" disabled>
                                                    </div>  

                                                    <br>
        
                                                    <div class="settings-requiring-restart-container">

                                                        <div id="hf_waitress_use_flash_attention_2" class="restart-settings-group">
                                                            <label class="hf-select-settings-labels-group">Use Flash Attention 2? Ensure hardware and software requirements met (--use_flash_attention_2):</label>
                                                            <input type="radio" id="hf_waitress_use_flash_attention_2_yes" name="hf_use_fa2" value="y" style="margin-left: 7px;"> Yes
                                                            <input type="radio" id="hf_waitress_use_flash_attention_2_no" name="hf_use_fa2" value="n" style="margin-left: 7px;"> No (Default)
                                                        </div>
    
                                                        <br>

                                                        <div id="hf_waitress_torch_device_map" class="restart-settings-group hf-select-settings-divs-group">
                                                            <label class="hf-select-settings-labels-group">Select Inference Device basis appropriate PyTorch Installation (--torch_device_map):</label>
                                                            <br>
                                                            <select class="modal-selects" id="hf_waitress_torch_device_map_choice">
                                                                <option value="auto">auto (default)</option>
                                                                <option value="cuda">CUDA</option>
                                                                <option value="rocm">ROCm</option>
                                                                <option value="cpu">CPU</option>
                                                            </select>
                                                        </div>
            
                                                        <br>

                                                        <div id="hf_waitress_torch_dtype" class="restart-settings-group hf-select-settings-divs-group">
                                                            <label class="hf-select-settings-labels-group">Select Torch data type basis model Tensor type (--torch_dtype):</label>
                                                            <br>
                                                            <select class="modal-selects" id="hf_waitress_torch_dtype_choice">
                                                                <option value="auto">auto (default)</option>
                                                                <option value="torch.bfloat16">torch.bfloat16</option>
                                                                <option value="torch.float16">torch.float16</option>
                                                                <option value="torch.float32">torch.float32</option>
                                                                <option value="torch.float64">torch.float64</option>
                                                                <option value="torch.int8">torch.int8</option>
                                                                <option value="torch.int16">torch.int16</option>
                                                                <option value="torch.int32">torch.int32</option>
                                                                <option value="torch.int64">torch.int64</option>
                                                                <option value="torch.uint8">torch.uint8</option>
                                                                <option value="torch.bool">torch.bool</option>
                                                            </select>
                                                        </div>

                                                        <br>

                                                        <div id="hf_waitress_pipeline_task" class="restart-settings-group hf-select-settings-divs-group">
                                                            <label class="hf-select-settings-labels-group">Select Pipeline Task (--pipeline_task):</label>
                                                            <br>
                                                            <select class="modal-selects" id="hf_waitress_pipeline_task_choice">
                                                                <option value="text-generation">text-generation (default)</option>
                                                                <option value="audio-classification">audio-classification (in-development)</option>
                                                                <option value="automatic-speech-recognition">automatic-speech-recognition (in-development)</option>
                                                                <option value="depth-estimation">depth-estimation (in-development)</option>
                                                                <option value="document-question-answering">document-question-answering (in-development)</option>
                                                                <option value="feature-extraction">feature-extraction (in-development)</option>
                                                                <option value="fill-mask">fill-mask (in-development)</option>
                                                                <option value="image-classification">image-classification (in-development)</option>
                                                                <option value="image-feature-extraction">image-feature-extraction (in-development)</option>
                                                                <option value="image-segmentation">image-segmentation (in-development)</option>
                                                                <option value="image-to-image">image-to-image (in-development)</option>
                                                                <option value="image-to-text">image-to-text (in-development)</option>
                                                                <option value="mask-generation">mask-generation (in-development)</option>
                                                                <option value="object-detection">object-detection (in-development)</option>
                                                                <option value="question-answering">question-answering (in-development)</option>
                                                                <option value="summarization">summarization (in-development)</option>
                                                                <option value="table-question-answering">table-question-answering (in-development)</option>
                                                                <option value="text2text-generation">text2text-generation (in-development)</option>
                                                                <option value="text-classification">text-classification (in-development)</option>
                                                                <option value="text-generation">text-generation (in-development)</option>
                                                                <option value="text-to-audio">text-to-audio (in-development)</option>
                                                                <option value="token-classification">token-classification (in-development)</option>
                                                                <option value="translation">translation (in-development)</option>
                                                                <option value="translation_xx_to_yy">translation_xx_to_yy (in-development)</option>
                                                                <option value="video-classification">video-classification (in-development)</option>
                                                                <option value="visual-question-answering">visual-question-answering (in-development)</option>
                                                                <option value="zero-shot-classification">zero-shot-classification (in-development)</option>
                                                                <option value="zero-shot-image-classification">zero-shot-image-classification (in-development)</option>
                                                                <option value="zero-shot-audio-classification">zero-shot-audio-classification (in-development)</option>
                                                                <option value="zero-shot-object-detection">zero-shot-object-detection (in-development)</option>
                                                            </select>
                                                        </div>

                                                        <br>

                                                        <div id="hf_waitress_quantization" class="restart-settings-group hf-select-settings-divs-group">
                                                            <label class="hf-select-settings-labels-group">Quantization Method (--quantize):</label>
                                                            <br>
                                                            <select class="modal-selects" id="hf_waitress_quantization_choice">
                                                                <option value="quanto">Quanto (Default)</option>
                                                                <option value="bitsandbytes">BitsAndBytes</option>
                                                                <option value="hqq">HQQ</option>
                                                                <option value="n">No Quantization</option>
                                                            </select>
                                                        </div>

                                                        <br>

                                                        <div id="hf_waitress_quantization_level" class="restart-settings-group hf-select-settings-divs-group">
                                                            <label class="hf-select-settings-labels-group">Quantization Level (--quant_level):</label>
                                                            <br>
                                                            <select class="modal-selects" id="hf_waitress_quantization_level_choice">
                                                                <option value="int8">Int8 (Recommended)</option>
                                                                <option value="int4">Int4 (Default)</option>
                                                                <option value="int3">Int3 (HQQ Only)</option>
                                                                <option value="int2">Int2 (Quanto & HQQ only)</option>
                                                                <option value="int1">Int1 (HQQ Only - Not Recommended!)</option>
                                                            </select>
                                                        </div>

                                                        <br>
            
                                                        <div id="hf_waitress_hqq_group_size" class="restart-settings-group">
                                                            <label for="HfwHqqGroupSize" class="hf-select-settings-labels-group">HQQ Group Size (must be divisible by group_size) (--hqq_group_size): </label>
                                                            <input type="number" id="HfwHqqGroupSize" min="0" style="width: 15%;" value="64">
                                                        </div>

                                                        <br>
        
                                                        <div id="hf_waitress_port" class="restart-settings-group">
                                                            <label for="HfwPort" class="hf-select-settings-labels-group">HF-Waitress Server Port (default: 9069) (--port): </label>
                                                            <input type="number" id="HfwPort" min="0"  max="65535" style="width: 15%;" value="9069">
                                                        </div>
        
                                                        <br>
        
                                                        <div class="restart-warning">
                                                            <i class="fa-solid fa-exclamation-triangle"></i> Changes trigger restart!
                                                        </div>
        
                                                    </div>
        
                                                    <br>
            
                                                    <div id="hf_waitress_max_new_tokens">
                                                        <label for="HfwMaxNewToks" class="hf-select-settings-labels-group">Maximum New Tokens (X-Max-New-Tokens): </label>
                                                        <input type="number" id="HfwMaxNewToks" min="100" style="width: 15%;" value="500">
                                                    </div>

                                                    <br>

                                                    <div id="hf_waitress_return_full_text" class="hf-select-settings-divs-group">
                                                        <label class="hf-select-settings-labels-group">Return Full Text (X-Return-Full-Text):</label>
                                                        <input type="radio" id="hf_waitress_return_full_text_yes" name="hf_return_full_text" value="y" style="margin-left: 7px;"> Yes (Default)
                                                        <input type="radio" id="hf_waitress_return_full_text_no" name="hf_return_full_text" value="n" style="margin-left: 7px;"> No
                                                    </div>

                                                    <br>
        
                                                    <div id="hf_waitress_temperature_value">
                                                        <label for="HfwTempSlider" class="hf-select-settings-labels-group">Temperature (Randomness of generated text) (X-Temperature): </label>
                                                        <input type="range" id="HfwTempSlider" min="0" max="2" step="0.1" value="0.3">
                                                        <span id="HfwTempSliderValue">0.3</span>
                                                    </div>
        
                                                    <br>
        
                                                    <div id="hf_waitress_topk_value">
                                                        <label for="HfwTopkSlider" class="hf-select-settings-labels-group">Limit to K most probable tokens (X-Top-K): </label>
                                                        <input type="range" id="HfwTopkSlider" min="-1" max="100" step="1" value="40">
                                                        <span id="HfwTopkSliderValue">40</span>
                                                    </div>
        
                                                    <br>
        
                                                    <div id="hf_waitress_topp_value">
                                                        <label for="HfwToppSlider" class="hf-select-settings-labels-group">Limit to a subset of tokens with a cumulative probability above (X-Top-P): </label>
                                                        <input type="range" id="HfwToppSlider" min="0" max="1" step="0.01" value="0.95">
                                                        <span id="HfwToppSliderValue">0.95</span>
                                                    </div>
        
                                                    <br>
        
                                                    <div id="hf_waitress_minp_value">
                                                        <label for="HfwMinpSlider" class="hf-select-settings-labels-group">Minimum probability for considering a token, relative to most likely (X-Min-P): </label>
                                                        <input type="range" id="HfwMinpSlider" min="0" max="1" step="0.01" value="0.05">
                                                        <span id="HfwMinpSliderValue">0.05</span>
                                                    </div>
                                                    
                                                </div>
                                            </div>

                                        </div>

                                        <div id="llama_cpp_div" style="display: none;">

                                            <input type="file" name="llmFile" id="uploadLlm" style="display: none;">
                                            <button type="button" id="uploadLlmButton" class="btn btn-primary upload-file-btn" onclick="document.getElementById('uploadLlm').click();"><i class="fas fa-upload"></i> Upload an LLM</button>
                                            
                                            <br>
                                            <br>

                                            <div  id="localLlmSelection">
                                                <label style="margin-bottom: 3px;">Select a local LLM:</label>
                                                <br>
                                                <select class="modal-selects" name="model_choice" id="modelDropdown">
                                                    
                                                </select>
                                            </div>

                                            <br>

                                            <div  id="localLlmTemplateSelection">
                                                <label style="margin-bottom: 3px;">Select a Prompt-Template Format</label>
                                                <br>
                                                <select class="modal-selects" name="llm_template_choice" id="llmTemplateDropdown">
                                                    <option value="">Please select</option>
                                                    <option value="llama3">Llama-3 & 3.1 Prompt Template Format</option>
                                                    <option value="llama2">Llama-2 Prompt Template Format (Mistral Nemo-12B Instruct, Instruct-7B & MoE - v0.1 & v0.2, etc.)</option>
                                                    <option value="chatml">ChatML Prompt Template Format (Open & Nous Hermes-Mistral & MoE, etc.) </option>
                                                    <option value="phi3">Microsoft Phi-3 Prompt Template Format</option>
                                                    <option value="command-r">Cohere Command-R & Command-R+ Prompt Template Format</option>
                                                    <option value="deepseek">Deepseek-Coder Prompt Template Format</option>
                                                    <option value="deepseek-coder-v2">Deepseek-Coder-V2 Prompt Template Format</option>
                                                    <option value="gemma2">Google Gemma2 Prompt Template Format</option>
                                                    <option value="vicuna">Nous-Capybara Vicuna Prompt Template Format</option>
                                                    <option value="openchat">OpenChat-3.5-0106 Prompt Template Format</option>
                                                </select>
                                            </div>

                                            <br>

                                            <!--Advanced Settings Section Begins-->
                                            <a href="#" class="btn btn-link btn-primary llm-adv-set-toggle" id="advancedLlmSettingsToggle" data-bs-toggle="collapse" data-bs-target="#advancedLlmSettings" aria-expanded="false" aria-controls="advancedLlmSettings" style="display: inline-block;">
                                                Advanced Settings >>>
                                            </a>

                                            <div class="collapse" id="advancedLlmSettings">
                                                <div class="card card-body" style="background-color: #181A1B; border: none;">
                                                    
                                                    <!-- Add options here | TODO: style "Advanced Settings" button! -->
        
                                                    <button class="btn btn-primary" type="button" id="resetLlmAdvancedDefaults">Reset to Defaults</button>
        
                                                    <br>
        
                                                    <div class="settings-requiring-restart-container">
        
                                                        <div id="gpu_choice" class="restart-settings-group">
                                                            <label>Use GPU?</label>
                                                            <input type="radio" id="gpu_radio_yes" name="use_gpu" value="y" style="margin-left: 7px;"> Yes (NvCUDA)
                                                            <input type="radio" id="gpu_radio_no" name="use_gpu" value="n" style="margin-left: 7px;"> No
                                                            <br><label for="NumbGpuLayers">Number of Model-layers to offload to the GPU (-ngl): </label>
                                                            <input type="number" id="NumbGpuLayers" name="NumbGpuLayers" min="-1" style="width: 15%;" value="47">
                                                        </div>
            
                                                        <br>
            
                                                        <div id="ctx_length" class="restart-settings-group">
                                                            <label for="LlmCtxLgt">Context-Length (-c): </label>
                                                            <input type="number" id="LlmCtxLgt" name="LlmCtxLgt" min="128" style="width: 15%;" value="8192">
                                                        </div>
            
                                                        <br>
            
                                                        <div id="llm_max_new_tokens" class="restart-settings-group">
                                                            <label for="MaxNewToks">Maximum tokens to predict (-n): </label>
                                                            <input type="number" id="MaxNewToks" name="MaxNewToks" min="-1" style="width: 15%;" value="2048">
                                                        </div>
        
                                                        <br>
        
                                                        <div class="restart-warning">
                                                            <i class="fa-solid fa-exclamation-triangle"></i> Changes trigger restart!
                                                        </div>
        
                                                    </div>
        
                                                    <br>
        
                                                    <div id="temperature_value">
                                                        <label for="tempSlider">Temperature (Randomness of generated text): </label>
                                                        <input type="range" id="tempSlider" name="tempSlider" min="0" max="2" step="0.1" value="0.8">
                                                        <span id="tempSliderValue">0.8</span>
                                                    </div>
        
                                                    <br>
        
                                                    <div id="topk_value">
                                                        <label for="topkSlider">Limit to K most probable tokens (top_k): </label>
                                                        <input type="range" id="topkSlider" name="topkSlider" min="-1" max="100" step="1" value="40">
                                                        <span id="topkSliderValue">40</span>
                                                    </div>
        
                                                    <br>
        
                                                    <div id="topp_value">
                                                        <label for="toppSlider">Limit to a subset of tokens with a cumulative probability above (top_p): </label>
                                                        <input type="range" id="toppSlider" name="toppSlider" min="0" max="1" step="0.01" value="0.95">
                                                        <span id="toppSliderValue">0.95</span>
                                                    </div>
        
                                                    <br>
        
                                                    <div id="minp_value">
                                                        <label for="minpSlider">Minimum probability for considering a token, relative to most likely (min_p): </label>
                                                        <input type="range" id="minpSlider" name="minpSlider" min="0" max="1" step="0.01" value="0.05">
                                                        <span id="minpSliderValue">0.05</span>
                                                    </div>
        
                                                    <br>
        
                                                    <div id="nkeep_value">
                                                        <label for="nkeepSlider">Prompt-tokens retained when context-size exceeded (n_keep, -1 to retain all): </label>
                                                        <input type="number" id="nkeepSlider" name="nkeepSlider" min="-1" style="width: 15%;" value="0">
                                                    </div>
                                                    
                                                </div>
                                            </div>

                                        </div>

                                    </div>

                                    <div id="apiLlmDiv" style="display: none;">
                                        
                                        <div id="apiLlmSelection">
                                            <label style="margin-bottom: 3px;">Select an LLM-API Inferencing Service:</label>
                                            <br>
                                            <select class="modal-selects" name="llm_api_choice" id="llmApiDropdown">
                                                <option value="">Please select</option>
                                                <option value="AzureOpenAI">Azure OpenAI Service</option>
                                                <!-- Add more API services here!-->
                                            </select>
                                        </div>
                                        
                                        <br>
    
                                        <form action="" class="api_form" id="azure_openai_api_form" style="display: none;">
                                            <div class="form-group">
                                                <input type="checkbox" id="update_azure_gpt" name="update_azure_gpt">
                                                <label for="update_azure_gpt">Update Configuration</label>
                                            </div>
                                            <div class="form-group">
                                                <label for="azure_openai_api_url">Azure OpenAI Base URL:</label>
                                                <input type="text" id="azure_openai_api_url" name="azure_openai_api_url" disabled>
                                            </div>
                                            <div class="form-group">
                                                <label for="azure_openai_api_key">Azure OpenAI GPT Key:</label>
                                                <input type="text" id="azure_openai_api_key" name="azure_openai_api_key" disabled>
                                            </div>
                                            <div class="form-group">
                                                <label for="azure_openai_deployment_name">Azure OpenAI GPT Deployment Name:</label>
                                                <input type="text" id="azure_openai_deployment_name" name="azure_openai_deployment_name" disabled>
                                            </div>
                                            <br>
                                        </form>

                                    </div>

                                </div>

                                <div id="option2" class="d-none">
                                    <!--Option 2 Content-->
                                    <h5>Switch Between Available Embedding Models</h5>

                                    <br>

                                    <div id="embed_model_choice">
                                        <label style="margin-bottom: 3px;">Select an Embedding Model:</label>
                                        <br>
                                        <select class="modal-selects" name="specify_embedding_model" id="embedding_model_dropdown">
                                            <option value="bge_large">BGE-Large</option>
                                            <option value="bge_base">BGE-Base</option>
                                            <option value="sbert_mpnet_base_v2">SBERT: all-mpnet-base-v2</option>
                                            <option value="openai_text_ada">OpenAI: Text-Ada</option>
                                            <!-- Add more embedding models here!-->
                                        </select>
                                    </div>

                                    <br>

                                    <form action="" class="api_form" id="azure_openai_text_ada_api_form" style="display: none;">
                                        <div class="form-group">
                                            <input type="checkbox" id="update_azure_ada" name="update_azure_ada">
                                            <label for="update_azure_ada">Update Configuration</label>
                                        </div>
                                        <div class="form-group">
                                            <label for="azure_openai_text_ada_api_url">Azure OpenAI Base URL:</label>
                                            <input type="text" id="azure_openai_text_ada_api_url" name="azure_openai_text_ada_api_url" disabled>
                                        </div>
                                        <div class="form-group">
                                            <label for="azure_openai_text_ada_api_key">Azure OpenAI Text-Ada Key:</label>
                                            <input type="text" id="azure_openai_text_ada_api_key" name="azure_openai_text_ada_api_key" disabled>
                                        </div>
                                        <div class="form-group">
                                            <label for="azure_openai_text_ada_deployment_name">Azure OpenAI Text-Ada Deployment Name:</label>
                                            <input type="text" id="azure_openai_text_ada_deployment_name" name="azure_openai_text_ada_deployment_name" disabled>
                                        </div>
                                        <br>
                                    </form>
                                    
                                    <label>Documents Embedded into VectorDB with this Model:</label>

                                    <br>
                                    <br>

                                    <div id="vector_embeddings_details">
                                        
                                        <table id="docs_loaded_details_table">  <!--TODO: table wrap per div width-->
                                            <tr>
                                                <th>Document Name</th>
                                                <th>VectorDB Location</th>
                                                <th>Chunk Size</th>
                                                <th>Chunk Overlap</th>
                                            </tr>
                                            <tr>
                                                <td>placeholder</td>
                                                <td>placeholder</td>
                                                <td>placeholder</td>
                                                <td>placeholder</td>
                                            </tr>
                                        </table>

                                        <br>

                                        <button class="btn btn-primary" type="button" id="resetVectorDB">Reset VectorDB</button>    <!--TODO: confirmation dialogue: are you sure you want to reset?-->

                                    </div>

                                </div>

                                <div id="option3" class="d-none">
                                    <!--Option 3 Content-->
                                    <h5>Edit System Prompt</h5>

                                    <!--Dropdown-->
                                    <div class="dropdown">
                                        <button class="btn btn-secondary dropdown-toggle" type="button" id="templateDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                            Default
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="templateDropdown">
                                            <li><a class="dropdown-item" id="template_dropdown_default" href="#" data-readonly="true" data-template="">Default</a></li>
                                            <li><a class="dropdown-item" id="template_dropdown_custom" href="#" data-readonly="false" data-template="">Custom</a></li>
                                        </ul>
                                    </div>

                                    <!-- <textarea class="form-control mt-2" rows="5" readonly>Use the context and question below of to answer the user's question. Answer in as much detail as possible. Context: {context} Question: {question}</textarea> -->
                                    <textarea id="templateContent" class="form-control mt-2" rows="5" readonly></textarea>
                                </div>

                                <div id="option4" class="d-none">
                                    <!--Option 4 Content-->
                                    <h5>RAG Settings:</h5>
                                    <br>
                                    <div>
                                        <input type="checkbox" id="force_enable_rag_checkbox" name="force_enable_rag">
                                        <label for="force_enable_rag_checkbox">Force Enable RAG</label>
                                    </div>
                                    
                                    <br>
                    
                                     <div>
                                        <input type="checkbox" id="force_disable_rag_checkbox" name="force_disable_rag">
                                        <label for="force_disable_rag_checkbox">Force Disable RAG</label>
                                    </div>
                                    
                                    <br>
                    
                                    <div>
                                        <input type="checkbox" id="default_rag_checkbox" name="default_rag" checked>
                                        <label for="default_rag_checkbox">Default RAG Setting (select this if unsure; implements RAG when necessary)</label>
                                    </div>
                                    
                                    <br>
                                </div>

                                <div id="option5" class="d-none">
                                    <!--Option 1 Content-->
                                    <h5>Optical Character Recognition (OCR): Specify Usage & Service</h5>

                                    <br>
                                    
                                    <div id="ocr_use_choice" class="modal-selection-radios">
                                        <label for="ocr_yes_radio_button" style="flex: 1;">
                                            <input type="radio" id="ocr_yes_radio_button" name="specify_ocr_and_service" value="ocr"> Use OCR Service Specified Below
                                        </label>
                                        <label for="ocr_no_radio_button" style="flex: 1;">
                                            <input type="radio" id="ocr_no_radio_button" name="specify_ocr_and_service" value="pypdf" checked> Do NOT use OCR (scanned docs not supported) 
                                        </label>
                                    </div>

                                    <br>

                                    <div id="apiOcrSelection" style="display: none;">
                                        <label style="margin-bottom: 3px;">Select an OCR Service:</label>
                                        <br>
                                        <select class="modal-selects" name="ocr_api_choice" id="ocrApiDropdown">
                                            <option value="">Please select</option>
                                            <option value="AzureVision">Azure Vision Service OCR</option>
                                            <option value="AzureDocAi">Azure Document Intelligence AI OCR</option>
                                            <!-- Add more OCR services here!-->
                                        </select>
                                    </div>
                                    
                                    <br>

                                    <form action="" class="api_form" id="azure_vision_api_form" style="display: none;">
                                        <div class="form-group">
                                            <input type="checkbox" id="update_azure_vision" name="update_azure_vision">
                                            <label for="update_azure_vision"> Update Configuration</label>
                                        </div>
                                        <div class="form-group">
                                            <input type="checkbox" id="is_azure_cv_free_tier" name="is_azure_cv_free_tier" disabled>
                                            <label for="is_azure_cv_free_tier"> Free Tier?</label>
                                        </div>
                                        <div class="form-group">
                                            <label for="azure_vision_api_url">Azure Vision OCR Endpoint:</label>
                                            <input type="text" id="azure_vision_api_url" name="azure_vision_api_url" disabled>
                                        </div>
                                        <div class="form-group">
                                            <label for="azure_vision_api_key">Azure Vision OCR Key:</label>
                                            <input type="text" id="azure_vision_api_key" name="azure_vision_api_key" disabled>
                                        </div>
                                        <br>
                                    </form>

                                    <form action="" class="api_form" id="azure_doc_ai_api_form" style="display: none;">
                                        <div class="form-group">
                                            <input type="checkbox" id="update_azure_doc_ai" name="update_azure_doc_ai">
                                            <label for="update_azure_doc_ai">Update Configuration</label>
                                        </div>
                                        <div class="form-group">
                                            <label for="azure_doc_ai_api_url">Azure Document-Intelligence AI OCR Endpoint:</label>
                                            <input type="text" id="azure_doc_ai_api_url" name="azure_doc_ai_api_url" disabled>
                                        </div>
                                        <div class="form-group">
                                            <label for="azure_doc_ai_api_key">Azure Document-Intelligence AI OCR Key:</label>
                                            <input type="text" id="azure_doc_ai_api_key" name="azure_doc_ai_api_key" disabled>
                                        </div>
                                        <br>
                                    </form>

                                </div>

                                <div id="option6" class="d-none">
                                    <!--Option 6 Content-->
                                    <h5>Google Drive Loader</h5>
                                    <br>
                                    <button class="btn btn-primary" type="button" id="googleDriveLogin">Login to / Refresh your Google Drive</button>

                                    <br>
                                    <br>

                                    <label>Google Drive File Browser:</label>

                                    <div id="loader" class="loader" style="display: none;"></div>

                                    <div id="google_drive_file_browser">
                                        <div class="mb-3">
                                            <select id="filterDocType" class="form-select">
                                                <option value="">All Document Types</option>
                                            </select>
                                        </div>
                                        
                                        <table id="google_drive_files_tables" class="gdrive-table">  <!--TODO: table wrap per div width-->
                                            <thead>
                                                <!-- <tr>
                                                    <th>Sync</th>
                                                    <th style="text-align: left;">Name</th>
                                                    <th style="text-align: left;">Type</th>
                                                    <th>Icon</th>
                                                    <th>Document Version</th>
                                                    <th>Sync Status</th>
                                                </tr> -->
                                                <tr>
                                                    <th>
                                                        <input type="checkbox" id="selectAll">
                                                        <button id="sortSelected" class="btn btn-sm btn-outline-secondary">Sort Selected</button>
                                                    </th>
                                                    <th style="text-align: left;">
                                                        Name
                                                        <button class="sort-btn" data-sort="name" data-order="none">â†•</button>
                                                    </th>
                                                    <th style="text-align: left;">
                                                        Type
                                                        <button class="sort-btn" data-sort="type" data-order="none">â†•</button>
                                                    </th>
                                                    <th>Icon</th>
                                                    <th>Document Version</th>
                                                    <th>Sync Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>

                                    </div>
                                    <button class="btn btn-primary" type="button" id="googleDriveSyncAction" style="display: none;">Sync Files</button>
                                </div>

                                <div id="option7" class="d-none">
                                    <!--Option 6 Content-->
                                    <h5>Additional Settings</h5>
                                    <br>
                                    <p>Look forward to future updates!</p>
                                </div>

                                <!--Add as Needed-->

                            </div>

                        </div>

                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="saveChangesButton" class="btn btn-primary" data-bs-dismiss="modal">Save Changes</button>
                    </div>

                </div>
            </div>
        </div>
        <!--
            NOTES ON ABOVE:
            1) tabindex="-1"
                This attrib indicates if elements can receive keyboard input focus, i.e. are reachable via the tab key
                0 means they can be included in the natural order
                -1 makes sure the modal does nnot get focus when tabbing through the page, instead waiting for the modal to be opened
            2) aria-labelledby="settingsModalLabel"
                An ARIA (Accessible Rich Internet Apps) attrib that establishes relations between elements and the text labelling them
                The value of the aria-labelledby attribute is the ID of another element that provides a label for this element. 
                In this case, it suggests that there is an element with the ID settingsModalLabel that provides a label (probably a title) for the modal.
                This helps screen readers to announce the modal's title (or label) when the modal is opened, providing a context for users with visual disabilities.
            3) aria-hidden="true":
                aria-hidden is another ARIA attribute. When set to "true", it indicates that the element and its children are not visible or perceivable to screen readers, even if they are visually shown on the page.
                For a Bootstrap modal, this attribute is typically toggled between true and false. When the modal is not displayed (closed), aria-hidden="true" ensures that screen readers ignore it. When the modal is open, this attribute is usually set to false, making it perceivable to screen readers.
                It's an important attribute to ensure that visually hidden content doesn't confuse or interfere with the experience of screen reader users.
            4) data-bs-dismiss="modal":
                used to close the modal when the element with this attribute is clicked
                Typically, you'll see this attribute on a button or a close icon inside the modal. When a user clicks this button/icon, the modal will close. The value "modal" specifies the type of component to dismiss.
                It's a part of Bootstrap's JavaScript functionalities, meaning Bootstrap's scripts detect this attribute and automatically bind the necessary event handlers.
            5) aria-label="Close":
                used to define a string that labels the current element
                In the context of a close button or icon in a modal, aria-label="Close" provides an accessible name for the button or icon so that assistive technologies, like screen readers, can announce it appropriately.
                This is especially important for elements that don't have visible text
            -->

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    
        <script>

            let CHAT_ID;
            let SEQUENCE_ID;
            let ascending = true;
            let LLM_MODEL;


            function errorHandler(attempted_action, error_generator, error_message) {
                let error_alert_message = "There was an error when "  + attempted_action + " in the method " + error_generator + ", more details can be viewed in the browser's console. "
                let full_error_message =  error_alert_message + error_message;
                console.error(full_error_message);
                alert(error_alert_message);
                document.getElementById('ModelAndDBLoading').style.display = 'none';
                document.getElementById('SavingHfWaitressSettings').style.display = 'none';  
            }

            const forceEnableRagCheckbox = document.getElementById('force_enable_rag_checkbox');
            const forceDisableRagCheckbox = document.getElementById('force_disable_rag_checkbox');
            const defaultRag = document.getElementById('default_rag_checkbox');

            function updateCheckboxes(checkedBox) {
                const checkboxes = [forceEnableRagCheckbox, forceDisableRagCheckbox, defaultRag];
                checkboxes.forEach(checkbox => {
                    checkbox.checked = checkbox === checkedBox;
                });
            }

            //Listeners for Checkbox Changes
            [forceEnableRagCheckbox, forceDisableRagCheckbox, defaultRag].forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        updateCheckboxes(this);
                    }
                });
            });

            function showLoader() {
                document.getElementById('loader').style.display = 'block';
            }

            function hideLoader() {
                document.getElementById('loader').style.display = 'none';
            }
            
            function openNav() {
                document.getElementById("sidenav").style.width = "250px";
                document.getElementById("sidenav").style.left = "0";
            }

            function closeNav() {
                document.getElementById("sidenav").style.width = "0";
                document.getElementById("sidenav").style.left = "-2px";
            }

            function setServerStatusIndicator(status) {
                document.getElementById('local_llm_server_status_indicator_text').innerHTML = `<i class="fa-solid fa-circle"></i> Server ${status}`;
                document.getElementById('local_llm_server_status_indicator_text').style.color = status === "Online" ? "green" : "red";
            }

            function attachWindowEvents() {
                const customSelect = document.getElementById('hf-waitress-llm-custom-select');
                const dropdownContent = document.getElementById('hf-waitress-llm-custom-dropdown-content');
                const addInput = document.getElementById('hf-waitress-llm-custom-dropdown-add-input');
                const addBtn = document.getElementById('hf-waitress-llm-custom-dropdown-add-btn');
                
                window.addEventListener('click', function(e) {
                    if (customSelect && !customSelect.contains(e.target)) {
                        dropdownContent.classList.remove('show');
                        addInput.style.display = 'none';
                        addBtn.style.display = 'block';
                    }
                });
            }


            function sortNavItems() {
                
                // Get all nav-items
                const nodeList = document.querySelectorAll('.nav-item');

                // Reverse nav-items
                const reversedNodes = Array.prototype.slice.call(nodeList).reverse();
                // Explanation:
                // querySelectorAll returns a NodeList, which is different from an array and thus does not have array methods available to it, such as reverse()
                // To use reverse(), we must call array methods on our NodeList as if it were an array
                // To do so, we use 'Array.prototype' as all JS objects have a prototype, which is itself an object, and thus inherits all props and methods of the JS object, such as arrays in this case
                // The slice() method returns a shallow copy of a protion of an array. If no bounds are specified, it returns the entire array
                // Every function in JS has a call() method, allowing you to set the value of 'this' for the duration of the function's execution
                // This effectively let's you borrow a function, using it as if it belongs to a different object than the one it's actually attached to
                // This lets us call Array's reverse() on our NodeList!
                
                // Get parent <div> container
                const parent = document.getElementById('sidenav-content');

                // Reverse and append nav-items:
                reversedNodes.forEach(node => parent.appendChild(node));
                // When calling appendChild on an element that's already part of the DOM, a duplicate will not be created, it'll simply be moved to a new position
                // This allows us to reverse and reinsert without clearing all nav-items first!
                
            }


            function openTab(evt, tabName, streamSessionId) {
                console.log("Openning clicked tab");
                var i, tabcontent, tabbuttons;
                tabcontent = document.getElementsByClassName("tab-content");
                for (i = 0; i < tabcontent.length; i++) {
                    if (tabcontent[i].getAttribute('stream-session-id') === streamSessionId) {
                        tabcontent[i].style.display = "none";
                    }
                }
                tabbuttons = document.getElementsByClassName("tab-button");
                for (i = 0; i < tabbuttons.length; i++) {
                    if (tabbuttons[i].getAttribute('stream-session-id') === streamSessionId) {
                        tabbuttons[i].className = tabbuttons[i].className.replace(" active", "")
                    }
                }
                document.getElementById(tabName).style.display = "block";
                
                // Find the button that opens this tab and add the active class
                var activeButton = document.querySelector(`button[onclick="openTab(event, '${tabName}', '${streamSessionId}')"]`);
                if (activeButton) {
                    activeButton.className += " active";
                }
            }


            function loadChatHistoryMenu() {
                
                //Make a GET request to the server
                fetch('/load_chat_history_list')
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response.json()
                })
                .then(data => {
                    if (data.success) {

                        history_list = data.history_list
                        //console.log(data)

                        let sidenav = document.getElementById('sidenav-content');

                        for(let i = 0; i < history_list.length; i++) {
                            let newDiv = document.createElement('div');
                            newDiv.className = 'nav-item';
                            newDiv.textContent = `Chat ${history_list[i]}`
                            newDiv.setAttribute('data-chat-id', history_list[i])
                            newDiv.addEventListener('click', function() {
                                console.log("clicked")
                                let chatID = this.getAttribute('data-chat-id');
                                loadChatHistory(chatID);
                            });
                            sidenav.appendChild(newDiv);
                        }
                    } else {
                        throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                    }
                })
                .catch(error => {
                    errorHandler("fetching the history-menu list", "/load_chat_history_list", String(error.message))
                });
            }


            async function updateHfModelList(newModelList) {
                console.log("Updating HF-Waitress model list");
                const response = await fetch('http://localhost:9069/hf_config_writer_api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ config_updates: { model_list: newModelList } })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response.json()
                })
                .then(data => {
                    if (data.success) {
                        console.log("HF-Waitress model list updated successfully");
                    } else {
                        throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                    }
                })
                .catch(error => {
                    errorHandler("updating the HF-Waitress model list", "updateHfModelList()", String(error.message))
                });
            }
            

            function setDefaultTemplate() {
                let defaultTemplate = `Answer the user's question in as much detail as possible. Be very helpful, witty and precise. Do not make up answers or fabricate false information!`;

                document.getElementById('templateContent').value = defaultTemplate;     // set prompt-textarea value
                document.getElementById('template_dropdown_default').setAttribute('data-template', defaultTemplate);    // set 'Default' list-item attribute value

                document.getElementById('templateDropdown').textContent = 'Default';    //Set default dropdown button text
            }

            
            function resetLlmAdvancedDefaults() {
                document.getElementById('gpu_radio_yes').checked = true;
                document.getElementById('gpu_radio_no').checked = false;
                document.getElementById("NumbGpuLayers").disabled = false;
                document.getElementById('NumbGpuLayers').value = "47";
                document.getElementById('LlmCtxLgt').value = "8192";
                document.getElementById('MaxNewToks').value = "2048";
                document.getElementById('tempSlider').value = "0.8";
                document.getElementById('tempSliderValue').textContent = "0.8"
                document.getElementById('topkSlider').value = "40";
                document.getElementById('topkSliderValue').textContent = "40";
                document.getElementById('toppSlider').value = "0.95";
                document.getElementById('toppSliderValue').textContent = "0.95";
                document.getElementById('minpSlider').value = "0.05";
                document.getElementById('minpSliderValue').textContent = "0.05";
                document.getElementById('nkeepSlider').value = "0";
            }


            function resetHfLlmAdvancedDefaults() {
                document.getElementById('hf_waitress_is_awq_yes').checked = false;
                document.getElementById('hf_waitress_is_awq_no').checked = true;
                document.getElementById('hf_waitress_trust_remote_code_yes').checked = true;
                document.getElementById('hf_waitress_trust_remote_code_no').checked = false;
                document.getElementById('hf_waitress_use_flash_attention_2_yes').checked = false;
                document.getElementById('hf_waitress_use_flash_attention_2_no').checked = true;
                document.getElementById('hf_waitress_return_full_text_yes').checked = false;
                document.getElementById('hf_waitress_return_full_text_no').checked = true;
                document.getElementById('update_hf_access_token').checked = false;
                document.getElementById('hf_access_token').disabled = true;
                document.getElementById('hf_waitress_torch_device_map_choice').value = 'auto';
                document.getElementById('hf_waitress_torch_dtype_choice').value = 'auto';
                document.getElementById('hf_waitress_pipeline_task_choice').value = 'text-generation';
                document.getElementById('hf_waitress_quantization_choice').value = 'quanto';
                document.getElementById('hf_waitress_quantization_level_choice').value = 'int4';
                document.getElementById('HfwHqqGroupSize').value = "64";
                document.getElementById('HfwPort').value = "9069";
                document.getElementById('HfwMaxNewToks').value = "500";
                document.getElementById('HfwTempSlider').value = "0";
                document.getElementById('HfwTempSliderValue').textContent = "0.0"
                document.getElementById('HfwTopkSlider').value = "40";
                document.getElementById('HfwTopkSliderValue').textContent = "40";
                document.getElementById('HfwToppSlider').value = "0.95";
                document.getElementById('HfwToppSliderValue').textContent = "0.95";
                document.getElementById('HfwMinpSlider').value = "0.05";
                document.getElementById('HfwMinpSliderValue').textContent = "0.05";
            }

                        
            function clearDocsLoadedTable() {
                var table = document.getElementById('docs_loaded_details_table');

                for (var i = table.rows.length - 1; i > 0; i--) {   // HTML tables start at row 0, so the header row is 0 and won't be deleted thanks to the i > 0 condition. The length-1 is to account for 0-indexing as length may be 10, but max row index will be 9. 
                    table.deleteRow(i);
                }
            }

            
            function clearGoogleDriveTable() {
                var table = document.getElementById('google_drive_files_tables');
                var tbody = table.querySelector('tbody');
                tbody.innerHTML = '';
                document.querySelectorAll('.sort-btn').forEach(button => {
                    button.setAttribute('data-order', 'none');
                    button.textContent = 'â†•';
                });
            }


            function populateDocsLoadedTable() {
                
                let formData = new FormData();
                formData.append('embedding_model_choice', document.getElementById('embedding_model_dropdown').value);

                fetch('/fetch_file_list_for_vector_db', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {

                        clearDocsLoadedTable(); // clear the table since we now have new data

                        row_list = data.file_row_list;

                        var table = document.getElementById('docs_loaded_details_table');

                        for (var i = 0; i < row_list.length; i++) {
                            // var rowCount = table.rows.length;   // get the number of rows in the table
                            // var row = table.insertRow(rowCount);    // since HTML tables are initialized with row 0, rowCount will specify the current position to insert the new row

                            var row = table.insertRow(-1);    // Or simply, use -1 to auto-append at the end of the table!

                            // Now create and insert new cells into the row while simulataneously setting their content:
                            row.insertCell(0).innerHTML = row_list[i][0];   // Name
                            row.insertCell(1).innerHTML = row_list[i][1];   // VectorDB
                            row.insertCell(2).innerHTML = row_list[i][2];   // Chunk Size
                            row.insertCell(3).innerHTML = row_list[i][3];   // Chunk Overlap
                        }
                    } else {
                        throw new Error('Internal Server Error: Check server-log and server command-line for more details.')
                    }
                })
                .catch(error => {
                    errorHandler("fetching file list for the selected vector database", "/fetch_file_list_for_vector_db", String(error.message))
                });
            }

            
            function resetVectorDBtoBlank() {

                // Ask for user confirmation:
                if (!confirm("Are you sure you want to reset the VectorDB? The database will not be deleted from disk, and can be reverted to by manually modifying config.json")) {
                    return; // If cancelled by the user, exit the function!
                }

                let formData = new FormData();
                formData.append('embedding_model_choice', document.getElementById('embedding_model_dropdown').value);

                fetch('/reset_vector_db_on_disk', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        clearDocsLoadedTable();
                        if (data.restart_required) {    // Refresh the page to reset the vectorDB
                            location.reload();
                        }
                    } else {
                        throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                    }
                })
                .catch(error => {
                    errorHandler("resetting the specified vector database", "/reset_vector_db_on_disk", String(error.message))
                });
            }


            function openImageInNewTab(imageUrl) {
                window.open(imageUrl, '_blank');
            }

            function attachClickListeners() {
                document.querySelectorAll('.gallery-thumbnail').forEach(function(iframe) {
                    iframe,addEventListener('click', function() {
                        console.log('Clicked element:', iframe);
                        openImageInNewTab(iframe.src)
                    });
                });
            }

            function openImageGalleryModal(modalId) {
                document.getElementById(modalId).style.display = 'block';
                //attachClickListeners();
            }

            function closeImageGalleryModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }


            function xdrp_populateGoogleDriveTable(gdrive_files) {
                const gdriveTableBody = document.querySelector('#google_drive_files_tables tbody');

                gdrive_files.forEach((file, index) => {
                    const iconClass = getFileIconClass(file.type);
                    const rowHTML = `
                        <tr data-gdrive-file-id="${file.id}" data-gdrive-mime-type="${file.mimeType}">
                            <td class="checkbox-cell"><input type="checkbox" id="select-${parseInt(index)+1}"></td>
                            <td style="text-align:left">${file.name}</td>
                            <td style="text-align:left">${file.type}</td>
                            <td style="text-align:center"><i class="file-icon fa-solid ${iconClass}"></i></td>
                            <td style="text-align:center">v${file.version}</td>
                            <td style="text-align:center"><i class="fas fa-cloud-arrow-down"></i></td>
                        </tr>
                    `;
                    gdriveTableBody.insertAdjacentHTML('beforeend', rowHTML);
                });
            }

            function sortSelected() {
                const tbody = document.querySelector('#google_drive_files_tables tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                rows.sort((a,b) => {    // JS's built-in sort() method for arrays takes a comparison function as an argument, determining the order for two rows in this case
                    const aChecked = a.querySelector('input[type="checkbox"]').checked;
                    const bChecked = b.querySelector('input[type="checkbox"]').checked;
                    return bChecked - aChecked;     // Clever bit! In JS, true is treated as 1, and false 0, and in sorting a positive number comes first - thus putting checked rows first while maintaining the ordering when both rows are checked/unchecked!
                });
                tbody.innerHTML = '';
                tbody.append(...rows);
            }

            function sortByColumn(button) {
                const table = document.getElementById('google_drive_files_tables');
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const column = button.dataset.sort;
                const index = column === 'name' ? 1 : 2;    //determines which column to sort: 1 for Name, 2 for Type
                
                // Get current order, default to 'none' if not set
                const currentOrder = button.getAttribute('data-order') || 'none';
                const newOrder = currentOrder === 'none' || currentOrder === 'desc' ? 'asc' : 'desc';

                // Sort rows
                rows.sort((a,b) => {
                    const aValue = a.cells[index].textContent.trim();
                    const bValue = b.cells[index].textContent.trim();
                    const comparison = aValue.localeCompare(bValue, undefined, {numeric: true, sensitivity: 'base'});   //sorts the rows based on the text content of the cells in the chosen column -> localeCompare() is used for string comparison, which handles alphabetical sorting well; undefined: This is the locale parameter. By leaving it undefined, we're using the default locale of the browser; sensitivity: 'base': This setting makes the comparison insensitive to case and diacritics. For instance, "a" and "A" would be considered equal, as would "Ã©" and "e".
                    return newOrder === 'asc' ? comparison : -comparison    //localeCompare() returns a negative number if a should be sorted before b, and a positive number otherwise. If newOrder is 'asc', it returns `comparison` as is (ascending order) and if it's 'desc', then by negating the comparison result (-comparison), we reverse the sort order!
                });
                
                // Update button state
                button.setAttribute('data-order', newOrder);
                button.textContent = newOrder === 'asc' ? 'â†‘' : 'â†“';

                // Reset other buttons as should be sorted basis one column at any given time!
                table.querySelectorAll('.sort-btn').forEach(btn => {
                    if (btn !== button) {
                        btn.setAttribute('data-order', 'none');
                        btn.textContent = 'â†•';
                    }
                });

                // Clear and re-append the sorted rows!
                tbody.innerHTML = '';
                tbody.append(...rows);
            }

            function filterByDocType(e) {
                const filterValue = e.target.value.toLowerCase();
                const tbody = document.querySelector('#google_drive_files_tables tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                rows.forEach(row => {
                    const type = row.cells[2].textContent.toLowerCase();
                    row.style.display = filterValue === '' || type === filterValue ? '' : 'none';   //If the filter value is empty (showing all types) OR the row's type matches the filter value, set the row's display style to an empty string (which means "display normally"). Otherwise, set the row's display style to 'none!
                }); 
            }

            function selectAll(e) {
                const tbody = document.querySelector('#google_drive_files_tables tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));
                rows.forEach(row => {
                    row.querySelector('input[type="checkbox"]').checked = e.target.checked; //`e.target` refers to the checkbox that triggered the event (the "Select All" checkbox) and `e.target.checked` is a boolean value indicating whether this checkbox is checked or not, basis which the checkbox for all other rows is set via the querySelector.
                });
            }

            function initSortingAndFiltering() {
                // Sort by selected
                document.getElementById('sortSelected').addEventListener('click', sortSelected);

                // Sort by column
                
                // Approach 1 (Event Delegation) - unnecessary in this case as:
                // 1) Only two buttons, not a large number of elements
                // 2) Static elements in the header, not dynamically changing content
                // 3) Buttons themselves are not removed/added dynamically
                // document.getElementById('google_drive_files_tables').addEventListener('click', function(e) {
                //     const target = e.target;
                //     if (target.classList.contains('sort-btn')) {
                //         sortByColumn(target);
                //     }
                // });

                 // Approach 2 (Direct Attachment):
                const table = document.getElementById('google_drive_files_tables');
                table.querySelectorAll('.sort-btn').forEach(button => {
                    button.addEventListener('click', () => sortByColumn(button));
                });

                // Filter by document type
                document.getElementById('filterDocType').addEventListener('change', filterByDocType);

                // Select all checkboxes
                document.getElementById('selectAll').addEventListener('change', selectAll);
            }

            function populateGoogleDriveTable(gdrive_files) {
                const gdriveTableBody = document.querySelector('#google_drive_files_tables tbody');
                const filterSelect = document.getElementById('filterDocType');
                const docTypes = new Set();

                gdriveTableBody.innerHTML = '';
                filterSelect.innerHTML = '<option value="">All Document Types</option>';

                gdrive_files.forEach((file, index) => {
                    const iconClass = getFileIconClass(file.type);
                    const rowHTML = `
                        <tr data-gdrive-file-id="${file.id}" data-gdrive-mime-type="${file.mimeType}">
                            <td class="checkbox-cell"><input type="checkbox" id="select-${parseInt(index)+1}"></td>
                            <td style="text-align:left">${file.name}</td>
                            <td style="text-align:left">${file.type}</td>
                            <td style="text-align:center"><i class="file-icon fa-solid ${iconClass}"></i></td>
                            <td style="text-align:center">v${file.version}</td>
                            <td style="text-align:center"><i class="fas fa-cloud-arrow-down"></i></td>
                        </tr>
                    `;
                    gdriveTableBody.insertAdjacentHTML('beforeend', rowHTML);

                    docTypes.add(file.type);
                });

                // Populate filter options
                docTypes.forEach(type => {
                    filterSelect.insertAdjacentHTML('beforeend', `<option value="${type}">${type}</option>`);
                });
            }

            function loadGoogleDriveDoc(file_id, file_mimeType) {
                let formData = new FormData();
                formData.append('file_id', file_id);
                formData.append('file_mimeType', file_mimeType);

                return fetch('/google_drive_loader', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    if (!data.success) {
                        throw new Error('Failed to load document from Google Drive');
                    }
                    return data;
                })
                .catch(error => {
                    errorHandler("loading document from Google Drive", "/google_drive_loader", String(error.message));
                    throw error;  // Re-throw the error for handling in the calling function
                });
            }

            function updateUIForFile(row, status) {
                let statusCell = row.cells[row.cells.length - 1];

                statusCell.textContent = ''; // Clear existing content

                switch(status) {
                    case 'loading':
                        statusCell.innerHTML = '<div class="cell-loader"></div>';
                        break;
                    case 'waiting':
                        statusCell.innerHTML = '<i class="fas fa-clock waiting" title="Waiting"></i>';
                        break;
                    case 'success':
                        statusCell.innerHTML = '<i class="fas fa-check-circle success" title="Success"></i>';
                        break;
                    case 'failure':
                        statusCell.innerHTML = '<i class="fas fa-times-circle failure" title="Failed"></i>';
                        break;
                }
            }

            function triggerSyncGoogleDrive() {
                const table = document.getElementById('google_drive_files_tables');
                const syncButton = document.getElementById('googleDriveSyncAction');
                const selectedFiles = [];

                if (!table || !syncButton) {
                    console.error('Required elements not found');
                    return;
                }
                // console.log('Table element:', table);
                // console.log('Table innerHTML:', table.innerHTML)
                // console.log('Number of rows:', table.rows.length);
                // if (table.rows.length > 0) {
                //     console.log('First row:', table.rows[1].outerHTML);
                //     console.log('First row cells:', table.rows[1].cells.length);
                //     console.log('First row first cell:', table.rows[1].cells[0]);
                // }

                syncButton.disabled = true;

                for (let i = 1; i < table.rows.length; i++) {
                    const checkbox = table.rows[i].cells[0].querySelector('input[type="checkbox"]');
                    if (checkbox && checkbox.checked) {
                        selectedFiles.push({
                            id: table.rows[i].getAttribute('data-gdrive-file-id'),
                            mimeType: table.rows[i].getAttribute('data-gdrive-mime-type'),
                            row: table.rows[i]
                        });
                        // Add status cell if it doesn't exist
                        if (table.rows[i].cells.length < 6) {
                            table.rows[i].insertCell(-1);
                        }
                        updateUIForFile(table.rows[i], 'waiting');
                    }
                }

                // Process files sequentially
                selectedFiles.reduce((promise, file, index) => {
                    return promise.then(() => {
                        updateUIForFile(file.row, 'loading');
                        return loadGoogleDriveDoc(file.id, file.mimeType)
                            .then(() => {
                                console.log(`File ${index + 1} loaded successfully`);
                                clearDocsLoadedTable();
                                populateDocsLoadedTable();
                                updateUIForFile(file.row, 'success');
                            })
                            .catch(error => {
                                console.error(`Error loading file ${index + 1}:`, error);
                                updateUIForFile(file.row, 'failure');
                            });
                    });
                }, Promise.resolve())
                .finally(() => {
                    syncButton.disabled = false;
                    alert('Google Drive Synchronization completed!');
                });
            }

            function googleDriveLogin() {
                showLoader();
                fetch('/login_to_google_drive')
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        //alert("Google Drive Login Successful!")

                        fetch('/fetch_file_list_from_google_drive')
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(err => { throw new Error(err.error)});
                            }
                            return response.json()
                        })
                        .then(data => {
                            if (data.success) {
                                hideLoader();
                                console.log("GDrive Files Fetched");
                                console.log(data.gdrive_files);
                                if (data.gdrive_files.length > 0) {
                                    clearGoogleDriveTable();
                                    populateGoogleDriveTable(data.gdrive_files);
                                    document.getElementById('googleDriveSyncAction').style.display = 'block';
                                }
                            } else {
                                throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                            }
                        })
                        .catch(error => {
                            errorHandler("fetching file list from Google Drive", "/fetch_file_list_from_google_drive", String(error.message))
                        });

                    } else {
                        throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                    }
                })
                .catch(error => {
                    errorHandler("logging into Google Drive", "/login_to_google_drive", String(error.message))
                });
            }


            function checkLocalLLMServerStatus() {
                setServerStatusIndicator('Status Check In-Progress...');
                const server_to_check = document.getElementById('local_llm_server_select_dropdown').value;
                let formData = new FormData();
                formData.append('server_to_check', server_to_check);
                fetch('/check_local_llm_server_status', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response.json()
                })
                .then(data => {
                    if (data.success) {
                        console.log(data);
                        if (data.server_online) {
                            setServerStatusIndicator('Online');
                        } else {
                            setServerStatusIndicator('Offline');
                        }
                    } else {
                        throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                    }
                })
                .catch(error => {
                    errorHandler("checking local LLM server status", "checkLocalLLMServerStatus()", String(error.message))
                });
            }


            function removeModelFromCustomDropdown(model) {
                loadCoreHfValues()
                .then(hf_values => {
                    let model_list = hf_values.model_list;
                    model_list = model_list.filter(m => m.toLowerCase() !== model.toLowerCase());
                    updateHfModelList(model_list);
                    initializeHfWaitressCustomDropdown(model_list, hf_values.model_id);
                })
                .catch(error => {
                    errorHandler("removing the model_id from the list of LLMs (likely means the HF-Waitress server is offline)", "removeModelFromCustomDropdown()", String(error.message));
                });
            }


            function reverseSortCustomDropdown() {
                loadCoreHfValues()
                .then(hf_values => {
                    let reversed_model_list = hf_values.model_list.reverse();
                    updateHfModelList(reversed_model_list);
                    initializeHfWaitressCustomDropdown(reversed_model_list, hf_values.model_id);
                })
                .catch(error => {
                    errorHandler("reversing the LLM list (likely means the HF-Waitress server is offline)", "reverseSortCustomDropdown()", String(error.message));
                });
            }


            function filterCustomDropdown(search_words) {
                const customDropdownList = document.getElementById('hf-waitress-llm-custom-dropdown-items-list');
                const items = customDropdownList.getElementsByClassName('hf-waitress-llm-custom-dropdown-item');

                const searchQuery = search_words.toLowerCase();

                Array.from(items).forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(searchQuery)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                })
            }

            function addNewHfwModel(model) {
                loadCoreHfValues()
                .then(hf_values => {
                    let model_list = hf_values.model_list;
                    model_list.push(model);
                    updateHfModelList(model_list);
                    initializeHfWaitressCustomDropdown(model_list, hf_values.model_id);
                })
                .catch(error => {
                    errorHandler("adding a new model_id to the list of LLMs (likely means the HF-Waitress server is offline)", "addNewHfwModel()", String(error.message));
                });
            }

            
            ////////////////////////---------DOMContentLoaded Block Begins---------////////////////////////////
            function initializeChatLink() {
                var currentUrl = window.location.href;
                var chatLink = document.getElementById('dynamicChatLink');
                chatLink.href = currentUrl;
            }

            
            function initializeScrollDownButton() {
                //Scroll all the way down button:
                const scrollDownButton = document.getElementById('scrollDownButton');
                const chatArea = document.getElementById('chat-area');

                scrollDownButton.addEventListener('click', () => {
                    chatArea.scrollTop = chatArea.scrollHeight;
                });
            }

            
            function initializeUI() {
                attachWindowEvents();
                initializeChatLink();
                initializeScrollDownButton();
            }

            
            function setUIValues(values) {
                document.getElementById('NumbGpuLayers').value = values.local_llm_gpu_layers;
                document.getElementById('LlmCtxLgt').value = values.local_llm_context_length;
                document.getElementById('MaxNewToks').value = values.local_llm_max_new_tokens;
                document.getElementById('tempSlider').value = values.local_llm_temperature;
                document.getElementById('tempSliderValue').textContent = values.local_llm_temperature;
                document.getElementById('topkSlider').value = values.local_llm_top_k;
                document.getElementById('topkSliderValue').textContent = values.local_llm_top_k;
                document.getElementById('toppSlider').value = values.local_llm_top_p;
                document.getElementById('toppSliderValue').textContent = values.local_llm_top_p;
                document.getElementById('minpSlider').value = values.local_llm_min_p;
                document.getElementById('minpSliderValue').textContent = values.local_llm_min_p;
                document.getElementById('nkeepSlider').value = values.local_llm_n_keep;
            }

            
            function loadAndSetCoreValues() {
                const initKeysToRead = ['local_llm_server', 'model_choice', 'use_local_llm', 'use_gpu', 'embedding_model_choice', 'use_ocr', 'ocr_service_choice', 'local_llm_chat_template_format', 'force_enable_rag', 'force_disable_rag', 'base_template', 'local_llm_gpu_layers', 'local_llm_context_length', 'local_llm_max_new_tokens', 'local_llm_temperature', 'local_llm_top_k', 'local_llm_top_p', 'local_llm_min_p', 'local_llm_n_keep', 'azure_cv_free_tier']
                
                return fetch('/config_reader_api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({keys: initKeysToRead})
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response.json()
                })
                .then(data => {
                    setUIValues(data.values);
                    return data.values;
                })
                .catch(error => {
                    errorHandler("reading config.json", "/config_reader_api", String(error.message))
                });
            }

            
            function initializeLocalLLMServerDropdown(local_llm_server) {
                const llmServerDd = document.getElementById('local_llm_server_select_dropdown');

                for (let option of llmServerDd.options) {
                    if (option.value == local_llm_server) {
                        option.selected = true;
                        break;
                    }
                }

                document.getElementById('llama_cpp_div').style.display = local_llm_server === 'llama-cpp' ? 'block' : 'none';
                document.getElementById('hf_waitress_div').style.display = local_llm_server === 'hf-waitress' ? 'block' : 'none';
            }


            function loadCoreHfValues() {
                const initKeysToRead = [
                    'model_id',
                    'model_list',
                    'access_gated',
                    'trust_remote_code',
                    'torch_device_map',
                    'torch_dtype',
                    'use_flash_attention_2',
                    'pipeline_task',
                    'max_new_tokens',
                    'return_full_text',
                    'temperature',
                    'do_sample',
                    'top_k',
                    'top_p',
                    'min_p',
                    'n_keep',
                    'quantize',
                    'quant_level',
                    'port',
                    'awq',
                    'hqq_group_size'
                ]
                
                return fetch('http://localhost:9069/hf_config_reader_api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({keys: initKeysToRead})
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response.json()
                })
                .then(data => {
                    return data.values;
                })
                .catch(error => {
                    errorHandler("reading hf_config.json (likely means the HF-Waitress server is offline)", "loadCoreHfValues()", String(error.message))
                });
            }


            // function initializeHfModelDropdown(model_list, model_id) {
            //     const hfDropdown = document.getElementById('hfModelDropdown');
            //     for (let i = 0; i < model_list.length; i++) {
            //         const option = document.createElement('option');
            //         option.value = model_list[i];
            //         option.textContent = model_list[i];

            //         if (model_list[i].toLowerCase() == model_id.toLowerCase()) {
            //             option.selected = true;
            //         }
            //         hfDropdown.appendChild(option);
            //     }
            // }


            function initializeHfWaitressCustomDropdown(model_list, model_id) {
                const customDropdownList = document.getElementById('hf-waitress-llm-custom-dropdown-items-list');
                customDropdownList.innerHTML = '';

                const selectedValue = document.getElementById('hf-waitress-llm-custom-dropdown-selected-value');

                model_list.forEach(model => {
                    if (model.toLowerCase() == model_id.toLowerCase()) {
                        selectedValue.textContent = model;
                    }
                    const div = document.createElement('div');
                    div.className = 'hf-waitress-llm-custom-dropdown-item';
                    div.innerHTML = `
                        <span>${model}</span>
                        <span class="hf-waitress-llm-custom-dropdown-delete-btn">Ã—</span>
                    `;
                    const deleteButton = div.querySelector('.hf-waitress-llm-custom-dropdown-delete-btn');
                    deleteButton.addEventListener('click', (event) => { // instead of deleteButton.onclick = (event) => {
                        event.stopPropagation();    //This prevents the click event from bubbling up to the parent div onclick event, which would immediately close the dropdown
                        removeModelFromCustomDropdown(model);
                    });
                    div.addEventListener('click', () => {   // instead of div.onclick = () => {
                        selectedValue.textContent = model;
                        document.getElementById('hf-waitress-llm-custom-dropdown-content').classList.remove('show');
                    });
                    customDropdownList.appendChild(div);
                });
            }


            function initializeHfSettingsDropdowns(all_values) {
                const hfTorchDeviceMap = document.getElementById('hf_waitress_torch_device_map_choice');

                for (let option of hfTorchDeviceMap.options) {
                    if (option.value == all_values.torch_device_map) {
                        option.selected = true;
                        break;
                    }
                }

                const hfTorchDataType = document.getElementById('hf_waitress_torch_dtype_choice');

                for (let option of hfTorchDataType.options) {
                    if (option.value == all_values.torch_dtype) {
                        option.selected = true;
                        break;
                    }
                }

                const hfPipelineTask = document.getElementById('hf_waitress_pipeline_task_choice');

                for (let option of hfPipelineTask.options) {
                    if (option.value == all_values.pipeline_task) {
                        option.selected = true;
                        break;
                    }
                }

                const hfQuantMethod = document.getElementById('hf_waitress_quantization_choice');

                for (let option of hfQuantMethod.options) {
                    if (option.value == all_values.quantize) {
                        option.selected = true;
                        break;
                    }
                }

                const hfQuantLevel = document.getElementById('hf_waitress_quantization_level_choice');

                for (let option of hfQuantLevel.options) {
                    if (option.value == all_values.quant_level) {
                        option.selected = true;
                        break;
                    }
                }

            }


            function initializeHfRadioButtons(all_values) {
                document.getElementById('hf_waitress_is_awq_yes').checked = all_values.awq;
                document.getElementById('hf_waitress_is_awq_no').checked = !all_values.awq;

                document.getElementById('hf_waitress_trust_remote_code_yes').checked = all_values.trust_remote_code;
                document.getElementById('hf_waitress_trust_remote_code_no').checked = !all_values.trust_remote_code;

                document.getElementById('hf_waitress_use_flash_attention_2_yes').checked = all_values.use_flash_attention_2;
                document.getElementById('hf_waitress_use_flash_attention_2_no').checked = !all_values.use_flash_attention_2;

                document.getElementById('hf_waitress_return_full_text_yes').checked = all_values.return_full_text;
                document.getElementById('hf_waitress_return_full_text_no').checked = !all_values.return_full_text;
            }


            function setHfSlidersAndTextAreas(values) {
                document.getElementById('HfwHqqGroupSize').value = values.hqq_group_size;
                document.getElementById('HfwPort').value = values.port;
                document.getElementById('HfwMaxNewToks').value = values.max_new_tokens;
                document.getElementById('HfwTempSlider').value = values.temperature;
                document.getElementById('HfwTempSliderValue').textContent = values.temperature;
                document.getElementById('HfwTopkSlider').value = values.top_k;
                document.getElementById('HfwTopkSliderValue').textContent = values.top_k;
                document.getElementById('HfwToppSlider').value = values.top_p;
                document.getElementById('HfwToppSliderValue').textContent = values.top_p;
                document.getElementById('HfwMinpSlider').value = values.min_p;
                document.getElementById('HfwMinpSliderValue').textContent = values.min_p;
            }


            function initializeHfwServerConfig() {
                loadCoreHfValues()
                    .then(hf_values => {
                        // initializeHfModelDropdown(hf_values.model_list, hf_values.model_id);
                        initializeHfWaitressCustomDropdown(hf_values.model_list, hf_values.model_id);
                        initializeHfSettingsDropdowns(hf_values);
                        initializeHfRadioButtons(hf_values);
                        setHfSlidersAndTextAreas(hf_values);
                    })
                    .catch(error => {
                        errorHandler("initializing HF-Waitress Server config (likely means the HF-Waitress server is offline)", "initializeHfwServerConfig()", String(error.message));
                    });
            }

            
            function initializeModelDropdown(model_choice) {
                fetch('/load_local_models')
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        //console.log('model_choice:', model_choice);
                        const dropdown = document.getElementById('modelDropdown');
                        data.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            //console.log('Model:', model);

                            if (typeof model !== 'undefined' && typeof model_choice !== 'undefined') {
                                if (model.toLowerCase() == model_choice.toLowerCase()) {
                                    option.selected = true;
                                }
                            }
                            dropdown.appendChild(option);
                        });
                    } else {
                        throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                    }
                })
                .catch(error => {
                    errorHandler("fetching the model list", "/load_local_models", String(error.message))
                });
            }

            
            function initializeLLMTemplateDropdown(local_llm_chat_template_format) {
                const llmTempDd = document.getElementById('llmTemplateDropdown');

                for (let option of llmTempDd.options) {
                    if (option.value == local_llm_chat_template_format) {
                        option.selected = true;
                        break;
                    }
                }
            }

            
            function initializeGPURadioButtons(use_gpu) {
                document.getElementById('gpu_radio_yes').checked = use_gpu;
                document.getElementById('gpu_radio_no').checked = !use_gpu;
            }

            
            function initializeLLMRadioButtons(use_local_llm, model_choice) {
                var useLocalLlm = document.getElementById('local_llm_radio_button');
                var useApiLlm = document.getElementById('api_llm_radio_button');

                if (use_local_llm) {
                    useLocalLlm.checked = true;
                    useApiLlm.checked = false;
                } else {
                    useLocalLlm.checked = false;
                    
                    // select API service from dropwdown
                    var selectLlmApiForDropdown = document.getElementById('llmApiDropdown');

                    for (var i = 0; i < selectLlmApiForDropdown.length; i++) {
                        if (selectLlmApiForDropdown.options[i].value === model_choice) {
                            selectLlmApiForDropdown.options[i].selected = true;
                            break;
                        }
                    }
                    useApiLlm.checked = true;
                }
            }

            
            function toggleLocalLlmSelection() {    // Show or hide local-LLM selection:
                const selection = document.querySelector('input[name="use_local_or_api_llm"]:checked').value;
                document.getElementById('localLlmDiv').style.display = selection === 'local' ? 'block' : 'none';
                document.getElementById('apiLlmDiv').style.display = selection === 'api' ? 'block' : 'none';

                if (selection === 'local') {
                    document.getElementById('azure_openai_api_form').style.display = 'none'; //Hide API-Details-Form if local selected

                    const local_llm_server_selected = document.getElementById('local_llm_server_select_dropdown');

                    if (local_llm_server_selected === 'hf-waitress') {
                        document.getElementById('hf_waitress_div').style.display = 'block';
                        document.getElementById('llama_cpp_div').style.display = 'none';
                    } else if (local_llm_server_selected === 'llama-cpp') {
                        document.getElementById('hf_waitress_div').style.display = 'none';
                        document.getElementById('llama_cpp_div').style.display = 'block';
                    }
                } else {
                    // Collapse Advanced Settings if it's expanded
                    var advancedLlmSettings = document.getElementById('advancedLlmSettings');
                    if (advancedLlmSettings.classList.contains('show')) {
                        var bsCollapse = new bootstrap.Collapse(advancedLlmSettings, {
                            toggle: false
                        });
                        bsCollapse.hide();
                    }

                }
            }


            function toggleLocalLLMSettingsForms() {
                const selection = document.getElementById('local_llm_server_select_dropdown').value;

                if (selection === 'hf-waitress') {
                    initializeHfwServerConfig();
                }

                document.getElementById('llama_cpp_div').style.display = selection === 'llama-cpp' ? 'block' : 'none';
                document.getElementById('hf_waitress_div').style.display = selection === 'hf-waitress' ? 'block' : 'none';
            }

            
            function toggleLlmApiForm() {   // Show or hide API form:
                var selection = document.getElementById('llmApiDropdown').value;
                document.getElementById('azure_openai_api_form').style.display = selection === 'AzureOpenAI' ? 'block' : 'none';
                //Add more API form selectors here
            }
            
            
            function toggleNGL() {  // Enable or disable ngl based on use_gpu
                var selection = document.querySelector('input[name="use_gpu"]:checked').value;
                if(selection === 'y') {
                    document.getElementById("NumbGpuLayers").disabled = false;
                } else {
                    document.getElementById('NumbGpuLayers').value = "0";
                    document.getElementById("NumbGpuLayers").disabled = true;
                }
            }

            
            function initializeEventListenersForLLMTab() {
                // Event listener for Local LLM Server selection:
                document.getElementById('local_llm_server_select_dropdown').addEventListener('change', checkLocalLLMServerStatus);
                document.getElementById('local_llm_server_select_dropdown').addEventListener('change', toggleLocalLLMSettingsForms);

                // Event listener for LLM/API radio buttons:
                document.getElementById('local_llm_radio_button').addEventListener('change', toggleLlmApiForm);
                document.getElementById('local_llm_radio_button').addEventListener('change', toggleLocalLlmSelection);

                document.getElementById('api_llm_radio_button').addEventListener('change', toggleLlmApiForm);
                document.getElementById('api_llm_radio_button').addEventListener('change', toggleLocalLlmSelection);

                // Event listener for API dropdown:
                document.getElementById('llmApiDropdown').addEventListener('change', toggleLlmApiForm);

                // Event Listener for toggle GPU:
                document.getElementById('gpu_radio_yes').addEventListener('change', toggleNGL);
                document.getElementById('gpu_radio_no').addEventListener('change', toggleNGL);

                // Event listener for Reset Defaults button:
                document.getElementById('resetLlmAdvancedDefaults').addEventListener('click', resetLlmAdvancedDefaults);    //aparently, adding parenthesis () here will cause resetLlmAdvancedDefaults to run immediately when the script executes, not on button click. Removing them allows the function to be passed as a reference correctly on click.
                document.getElementById('resetHfLlmAdvancedDefaults').addEventListener('click', resetHfLlmAdvancedDefaults);

                // Initial state check:
                toggleLocalLlmSelection();
                toggleLlmApiForm();
                toggleNGL();

                document.getElementById('update_azure_gpt').addEventListener('change', function() {
                    document.getElementById('azure_openai_api_url').disabled = !this.checked;   
                    document.getElementById('azure_openai_api_key').disabled = !this.checked;   
                    document.getElementById('azure_openai_deployment_name').disabled = !this.checked;
                });

                document.getElementById('update_hf_access_token').addEventListener('change', function() {
                    document.getElementById('hf_access_token').disabled = !this.checked;   
                });

                // Event listener to toggle custom dropdown:
                document.getElementById('hf-waitress-llm-custom-select-header').addEventListener('click', function() {
                    document.getElementById('hf-waitress-llm-custom-dropdown-content').classList.toggle('show');
                });

                // Event listener to filter custom dropdown:
                document.getElementById('hf-waitress-llm-custom-dropdown-search-input').addEventListener('input', function() {
                    filterCustomDropdown(this.value);
                });

                // Event listener to add new item to custom dropdown:
                const addInput = document.getElementById('hf-waitress-llm-custom-dropdown-add-input');
                const addBtn = document.getElementById('hf-waitress-llm-custom-dropdown-add-btn');

                addBtn.addEventListener('click', function() {
                    addBtn.style.display = 'none';
                    addInput.style.display = 'block';
                });

                addInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && this.value) {
                        addNewHfwModel(this.value);
                        addInput.value = '';
                        addInput.style.display = 'none';
                        addBtn.style.display = 'block';
                    }
                });
            }

            
            function initializeEventListenersForLLMTabSliders() {
                document.getElementById('tempSlider').addEventListener('input', function() {
                    document.getElementById('tempSliderValue').textContent = this.value;
                });

                document.getElementById('topkSlider').addEventListener('input', function() {
                    document.getElementById('topkSliderValue').textContent = this.value;
                });

                document.getElementById('toppSlider').addEventListener('input', function() {
                    document.getElementById('toppSliderValue').textContent = this.value;
                });

                document.getElementById('minpSlider').addEventListener('input', function() {
                    document.getElementById('minpSliderValue').textContent = this.value;
                });

                document.getElementById('HfwTempSlider').addEventListener('input', function() {
                    document.getElementById('HfwTempSliderValue').textContent = this.value;
                });

                document.getElementById('HfwTopkSlider').addEventListener('input', function() {
                    document.getElementById('HfwTopkSliderValue').textContent = this.value;
                });

                document.getElementById('HfwToppSlider').addEventListener('input', function() {
                    document.getElementById('HfwToppSliderValue').textContent = this.value;
                });

                document.getElementById('HfwMinpSlider').addEventListener('input', function() {
                    document.getElementById('HfwMinpSliderValue').textContent = this.value;
                });
            }
            
            
            function initializeLLMTabComponents(values) {
                initializeLocalLLMServerDropdown(values.local_llm_server);
                initializeModelDropdown(values.model_choice);   
                initializeLLMTemplateDropdown(values.local_llm_chat_template_format);
                initializeGPURadioButtons(values.use_gpu);
                initializeLLMRadioButtons(values.use_local_llm, values.model_choice);
                initializeEventListenersForLLMTab();
                initializeEventListenersForLLMTabSliders();
            }

            
            function initializeEmbeddingModelDropdown(embedding_model_choice) {
                var selectEmbedModelForDropdown = document.getElementById('embedding_model_dropdown');

                for (var i = 0; i < selectEmbedModelForDropdown.length; i++) {
                    if (selectEmbedModelForDropdown.options[i].value === embedding_model_choice) {
                        selectEmbedModelForDropdown.options[i].selected = true;
                        clearDocsLoadedTable();
                        populateDocsLoadedTable();
                        break;
                    }
                }
            }

            
            function initializeEventListenersForEmbeddingModelTab() {
                // Show or hide API form:
                function toggleAzureAdaApiForm() {
                    var selection = document.getElementById('embedding_model_dropdown').value;
                    document.getElementById('azure_openai_text_ada_api_form').style.display = selection === 'openai_text_ada' ? 'block' : 'none';
                    //Add more API form selectors here
                }

                // Event listener for API dropdown:
                document.getElementById('embedding_model_dropdown').addEventListener('change', function() {
                    populateDocsLoadedTable();
                    toggleAzureAdaApiForm();
                });

                // Add Event Listener for ResetDB button:
                document.getElementById('resetVectorDB').addEventListener('click', resetVectorDBtoBlank);

                // Check init
                toggleAzureAdaApiForm();

                document.getElementById('update_azure_ada').addEventListener('change', function() {
                    document.getElementById('azure_openai_text_ada_api_url').disabled = !this.checked;    
                    document.getElementById('azure_openai_text_ada_api_key').disabled = !this.checked;   
                    document.getElementById('azure_openai_text_ada_deployment_name').disabled = !this.checked;   
                });
            }

            
            function initializeEmbeddingModelTabComponents(values) {
                initializeEmbeddingModelDropdown(values.embedding_model_choice);
                initializeEventListenersForEmbeddingModelTab();
            }

            
            function initializeSystemPromptTabListeners(base_template) {
                let default_system_template = document.getElementById('template_dropdown_default').getAttribute('data-template');

                if (base_template.toLowerCase().trim() != default_system_template.toLowerCase().trim()) {
                    document.getElementById('template_dropdown_custom').setAttribute('data-template', base_template);
                    document.getElementById('templateContent').value = base_template;
                    document.getElementById('templateContent').readOnly = false;
                    document.getElementById('templateDropdown').textContent = 'Custom';
                }

                // 3b. Set event-listeners for the template-choices:
                let dropdownItems = document.querySelectorAll('.dropdown-item');    // Get a reference to the dropdown items and the textarea
                let textarea = document.getElementById('templateContent');

                // 3c. Loop through each dropdown item
                dropdownItems.forEach(function(item) {
                    item.addEventListener('click', function(event) {

                        event.preventDefault();

                        // Get the template content from the clicked dropdown item's data-template attribute
                        let templateContent = event.target.getAttribute('data-template');
                        let isReadonly = event.target.getAttribute('data-readonly') === 'true'; // Convert string to boolean via '===' strict equality check: if the data-readonly attribute is true, the boolean isReadonly will be true, else false!

                        // Set the textarea value to the template content
                        textarea.value = templateContent;

                        // Set readonly attribute and placeholder
                        textarea.readOnly = isReadonly;
                        textarea.placeholder = isReadonly ? "" : "Use this space to enter your own prompt"; // No placeholder if readonly

                        // Change the dropdown button text to reflect the chosen template
                        document.getElementById('templateDropdown').textContent = event.target.textContent;

                    });
                });
            }

            
            function initializeSystemPromptTabComponents(values) {
                setDefaultTemplate();   // Set the default template when the page loads
                initializeSystemPromptTabListeners(values.base_template);
            }

            
            function initializeRAGTabCheckbox(force_enable_rag, force_disable_rag) {
                // Set RAG-Checkbox       
                if (force_enable_rag) {
                    console.log("Force enabling RAG")
                    updateCheckboxes(forceEnableRagCheckbox);
                } else if (force_disable_rag) {
                    console.log("Force disabling RAG")
                    updateCheckboxes(forceDisableRagCheckbox);
                } else {
                    updateCheckboxes(defaultRag);
                }
            }

            
            function initializeRAGTabComponents(values) {
                initializeRAGTabCheckbox(values.force_enable_rag , values.force_disable_rag);
            }

            
            function initializeOCRTabRadios(use_ocr, ocr_service_choice, azure_cv_free_tier) {
                var useOcr = document.getElementById('ocr_yes_radio_button');
                var usePypdf = document.getElementById('ocr_no_radio_button');

                if (use_ocr) {
                    useOcr.checked = true;

                    // select API service from dropwdown
                    var selectOcrApiForDropdown = document.getElementById('ocrApiDropdown');

                    for (var i = 0; i < selectOcrApiForDropdown.length; i++) {
                        if (selectOcrApiForDropdown.options[i].value === ocr_service_choice) {
                            selectOcrApiForDropdown.options[i].selected = true;
                            break;
                        }
                    }
                    
                    if (azure_cv_free_tier){
                        document.getElementById('is_azure_cv_free_tier').checked = true;
                    } else {
                        document.getElementById('is_azure_cv_free_tier').checked = false;
                    }

                    usePypdf.checked = false;
                } else {
                    useOcr.checked = false;
                    usePypdf.checked = true;
                }
            }

            
            function toggleOcrSelection() { //Show or hide OCR-Service selection:
                var selection = document.querySelector('input[name="specify_ocr_and_service"]:checked').value;
                document.getElementById('apiOcrSelection').style.display = selection === 'ocr' ? 'block' : 'none';
                if (selection === 'pypdf') {    //Hide API-Details-Form 
                    document.getElementById('azure_vision_api_form').style.display = 'none'; 
                    document.getElementById('azure_doc_ai_api_form').style.display = 'none';
                } else {
                    if (document.getElementById('ocrApiDropdown').value != 'AzureVision') {
                        document.getElementById('azure_vision_api_form').style.display = 'none'; //Hide API-Details-Form
                    } else if (document.getElementById('ocrApiDropdown').value != 'AzureDocAi') {
                        document.getElementById('azure_doc_ai_api_form').style.display = 'none';
                    }
                }
            }

            
            function toggleOcrApiForm() {   //Show or hide API form:
                var selection = document.getElementById('ocrApiDropdown').value;
                document.getElementById('azure_vision_api_form').style.display = selection === 'AzureVision' ? 'block' : 'none';
                document.getElementById('azure_doc_ai_api_form').style.display = selection === 'AzureDocAi' ? 'block' : 'none';
                //Add more API form selectors here
            }

            
            function initializeOCRTabListeners() {
                document.getElementById('update_azure_vision').addEventListener('change', function() {
                    document.getElementById('azure_vision_api_url').disabled = !this.checked;    
                    document.getElementById('azure_vision_api_key').disabled = !this.checked;
                    document.getElementById('is_azure_cv_free_tier').disabled = !this.checked;  
                });
                document.getElementById('update_azure_doc_ai').addEventListener('change', function() {
                    document.getElementById('azure_doc_ai_api_url').disabled = !this.checked;   // !this.check -> logical NOT to flip boolean. this.checked will be true when the box is checked, so !this.checked will be false... 
                    document.getElementById('azure_doc_ai_api_key').disabled = !this.checked;   // ...and so disabled will be false. So if Update-Config is checked, the fields are enabled.
                });

                // Event listener for radio buttons:
                document.getElementById('ocr_yes_radio_button').addEventListener('change', toggleOcrApiForm);
                document.getElementById('ocr_yes_radio_button').addEventListener('change', toggleOcrSelection);

                document.getElementById('ocr_no_radio_button').addEventListener('change', toggleOcrApiForm);
                document.getElementById('ocr_no_radio_button').addEventListener('change', toggleOcrSelection);

                // Initial state check:
                toggleOcrSelection();
                toggleOcrApiForm();

                // Event listener for API dropdown:
                document.getElementById('ocrApiDropdown').addEventListener('change', toggleOcrApiForm);
            }

            
            function initializeOCRTabComponents(values) {
                initializeOCRTabRadios(values.use_ocr, values.ocr_service_choice, values.azure_cv_free_tier);
                initializeOCRTabListeners();
            }


            function getFileIconClass(fileType) {
                const iconMap = {
                    'word': 'fa-file-word',
                    'presentation': 'fa-file-powerpoint',
                    'image': 'fa-file-image',
                    'text': 'fa-file-alt',
                    'folder': 'fa-folder',
                    'pdf': 'fa-file-pdf',
                    'other': 'fa-file'
                };
                return iconMap[fileType] || iconMap['other'];
            }

            
            function initializeGoogleDriveTabListeners() {
                document.getElementById('googleDriveLogin').addEventListener('click', googleDriveLogin);
                initSortingAndFiltering();  // Inititalize sorting and filtering
                document.getElementById('googleDriveSyncAction').addEventListener('click', triggerSyncGoogleDrive);
            }

            
            function initializeGoogleDriveTabComponents(values) {
                initializeGoogleDriveTabListeners();
            }

            
            function initializeSettingsModalTabCycleListener() {
                // Now that all on-load setup for Modal-Setting's Tabs based on config.json is completed, set listeners to cycle between tabs:
                let options = document.querySelectorAll('[data-content]');

                options.forEach(function(option) {
                    option.addEventListener('click', function(e) {
                        e.preventDefault();

                        // 1) Deavtivate all options: Make the clicked option active, by first marking all options as inactive
                        options.forEach(function(opt) {
                            opt.classList.remove('active');
                        });
                        option.classList.add('active'); //2) Activate the clicked option

                        // 3) Hide all detail panels on the right
                        // w-75 > div selects all div elements that are direct children of an element of class w-75. CSS selector syntax, with > denoting a direct child relationship
                        let details = document.querySelectorAll('.w-75 > div');
                        details.forEach(function(detail) {
                            detail.classList.add('d-none');
                        });

                        // 4) Reveal details for clicked option, by first hiding the detail divs for all options
                        let selectDetail = document.getElementById(option.getAttribute('data-content'));
                        selectDetail.classList.remove('d-none');
                    });
                });
            }

            
            function updateUIWithChatInfo(chat_id, llm_model) {
                curr_chat_id = chat_id
                curr_chat_id = " Chat ".concat(String(curr_chat_id))

                display_chatid_and_model = String(curr_chat_id).concat(": ", String(llm_model))

                document.getElementById('model_header').innerHTML = display_chatid_and_model;
                document.getElementById('model_header').style.display = 'block';
                
                document.getElementById('ModelAndDBLoading').style.display = 'none';
                document.getElementById('ReadyToChat').style.display = 'block';
                
                var timeoutDelayInMilliseconds = 1500; //1.5 seconds
                setTimeout(function() {
                    document.getElementById('ReadyToChat').style.display = 'none';
                }, timeoutDelayInMilliseconds);
            }

            
            function initChatHistoryDB(llm_model) {
                return fetch('/init_chat_history_db')
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // If LLM, VectorDB and chat history DB initialized successfully, continue:
                        CHAT_ID = data.chat_id;
                        updateUIWithChatInfo(data.chat_id, llm_model)
                    } else {
                        throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                    }
                })
                .catch(error => {
                    errorHandler("initializing the chat history DB", "/init_chat_history_db", String(error.message))
                });
            }

            
            function loadVectorDB(llm_model) {
                // Once the llama.cpp server is up (the LLM is loaded), load the VectorDB
                return fetch('/load_vectordb')
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        return initChatHistoryDB(llm_model);
                    } else {
                        throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                    }
                })
                .catch(error => {
                    errorHandler("loading the VectorDB", "/load_vectordb", String(error.message))
                });
            }

            
            function startLLMAndVectorDB() {
                // Finally, trigger the LLM & vectorDB starter!
                return fetch('/local_llm_server_starter')
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.other_server_running) {
                            alert("Warning: Both HF-Waitress and llama.cpp servers appear to be running. Consider manually shutting one down to conserve memory!")
                        }
                        setServerStatusIndicator("Online");
                        const llm_model = data.llm_model;
                        LLM_MODEL = String(data.llm_model);
                        return loadVectorDB(llm_model);
                    } else {
                        setServerStatusIndicator("Error");
                        throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                    }
                })
                .catch(error => {
                    setServerStatusIndicator("Offline");
                    errorHandler("loading the LLM", "/llama_cpp_server_starter", String(error.message))
                })
            }


            document.addEventListener("DOMContentLoaded", function() {
                initializeUI();
                document.getElementById('ModelAndDBLoading').style.display = 'block';   //Start initializing the chat session
                let local_llm_server;

                loadAndSetCoreValues()
                    .then(values => {
                        initializeLLMTabComponents(values);
                        initializeEmbeddingModelTabComponents(values);
                        initializeSystemPromptTabComponents(values);
                        initializeRAGTabComponents(values);
                        initializeOCRTabComponents(values);
                        initializeGoogleDriveTabComponents(values);
                        initializeSettingsModalTabCycleListener();
                        local_llm_server = values.local_llm_server;
                        return startLLMAndVectorDB();
                    })
                    .then(() => {
                        if (local_llm_server === "hf-waitress") {
                            initializeHfwServerConfig();
                        }
                        loadChatHistoryMenu();  // should be done regardless of errors
                    })
                    .catch(error => {
                        errorHandler("initializing the application", "DOMContentLoaded", String(error.message));
                    })
                    .finally(() => {

                    });
            });//########### End DOMContentLoaded Block!


            ///////////////////////---------SaveConfig Block Begins---------////////////////////////////
            function getLlmConfig() {
                const useLocalLlmRadioButton = document.getElementById('local_llm_radio_button');
                const useApiRadioButton = document.getElementById('api_llm_radio_button');
                const update_azure_gpt_config = document.getElementById('update_azure_gpt').checked;

                let config = {
                    'use_local_llm': useLocalLlmRadioButton.checked,
                    'use_azure_open_ai':false,
                };

                if (useLocalLlmRadioButton.checked) {
                    config.local_llm_server = document.getElementById('local_llm_server_select_dropdown').value;
                    if (config.local_llm_server === "llama-cpp") {
                        config.model_choice = document.getElementById('modelDropdown').value;
                        config.local_llm_chat_template_format = document.getElementById('llmTemplateDropdown').value;
                        config.use_gpu = document.getElementById('gpu_radio_yes').checked;
                        config.local_llm_gpu_layers = parseInt(document.getElementById('NumbGpuLayers').value);
                        config.local_llm_context_length = parseInt(document.getElementById('LlmCtxLgt').value);
                        config.local_llm_max_new_tokens = parseInt(document.getElementById('MaxNewToks').value);
                        config.local_llm_temperature = parseFloat(document.getElementById('tempSlider').value);
                        config.local_llm_top_k = parseInt(document.getElementById('topkSlider').value);
                        config.local_llm_top_p = parseFloat(document.getElementById('toppSlider').value);
                        config.local_llm_min_p = parseFloat(document.getElementById('minpSlider').value);
                        config.local_llm_n_keep = parseInt(document.getElementById('nkeepSlider').value);
                    } 
                } else if (useApiRadioButton.checked) {
                    config.model_choice = document.getElementById('llmApiDropdown').value;
                    if (config.model_choice === "AzureOpenAI") {
                        config.use_azure_open_ai = true;
                        if (update_azure_gpt_config) {
                            config.azure_openai_base_url = document.getElementById("azure_openai_api_url").value;
                            config.azure_openai_api_key = document.getElementById("azure_openai_api_key").value;
                            config.azure_openai_deployment_name = document.getElementById("azure_openai_deployment_name").value;
                        }
                    }
                }

                return config;
            }

            
            function getVectorEmbeddingsConfig() {
                const embedding_model_choice = document.getElementById('embedding_model_dropdown').value;
                const update_azure_ada_config = document.getElementById('update_azure_ada').checked;

                let config= {
                    'embedding_model_choice': embedding_model_choice,
                    'use_openai_embeddings': false,
                    'use_bge_large_embeddings': false,
                    'use_bge_base_embeddings': false,
                    'use_sbert_embeddings': false
                };
                
                switch(embedding_model_choice) {
                    case 'bge_large':
                        config.use_bge_large_embeddings = true;
                        break;
                    case 'bge_base':
                        config.use_bge_base_embeddings = true;
                        break;
                    case 'sbert_mpnet_base_v2':
                        config.use_sbert_embeddings = true;
                        break;
                    case 'openai_text_ada':
                        config.use_openai_embeddings = true;
                        if (update_azure_ada_config) {
                            config.azure_openai_text_ada_api_url = document.getElementById("azure_openai_text_ada_api_url").value;
                            config.azure_openai_text_ada_api_key = document.getElementById("azure_openai_text_ada_api_key").value;
                            config.azure_openai_text_ada_deployment_name = document.getElementById("azure_openai_text_ada_deployment_name").value;
                        }
                        break;
                }

                return config;
            }

            
            function getSysPromptConfig() {
                const selectedTemplateName = document.getElementById('templateDropdown').textContent.trim();
                let prompt_template;

                switch(selectedTemplateName) {
                    case 'Default':
                        prompt_template = document.getElementById('template_dropdown_default').getAttribute('data-template');
                        break;
                    case 'Custom':
                        prompt_template = String(document.getElementById('templateContent').value);
                        break;
                }

                return {'base_template': prompt_template};
            }

            
            function getRagConfig() {
                let force_enable_rag = false;
                let force_disable_rag = false; 

                if (forceEnableRagCheckbox.checked) {
                    force_enable_rag = true;
                } else if (forceDisableRagCheckbox.checked) {
                    force_disable_rag = true;
                }

                return {'force_enable_rag': force_enable_rag, 'force_disable_rag': force_disable_rag};
            }

            
            function getOcrConfig() {
                const azure_ocr_form = document.getElementById("azure_vision_api_form");
                const azure_doc_ai_form = document.getElementById("azure_doc_ai_api_form");
                const update_azure_vision_config = document.getElementById('update_azure_vision').checked;
                const update_azure_doc_ai_config = document.getElementById('update_azure_doc_ai').checked;

                let config = {
                    'ocr_service_choice': 'None',
                    'use_ocr': false
                };

                if (window.getComputedStyle(azure_ocr_form).display != 'none') {
                    config.ocr_service_choice = 'AzureVision';
                    config.use_ocr = true;
                    if (update_azure_vision_config) {
                        config.azure_cv_free_tier = document.getElementById('is_azure_cv_free_tier').checked;
                        config.azure_ocr_endpoint = document.getElementById("azure_vision_api_url").value;
                        config.azure_ocr_subscription_key = document.getElementById("azure_vision_api_key").value;
                    }
                } else if (window.getComputedStyle(azure_doc_ai_form).display != 'none') {
                    config.ocr_service_choice = 'AzureDocAi';
                    config.use_ocr = true;
                    if (update_azure_doc_ai_config) {
                        config.azure_doc_ai_endpoint = document.getElementById("azure_doc_ai_api_url").value;
                        config.azure_doc_ai_subscription_key = document.getElementById("azure_doc_ai_api_key").value;
                    }
                }

                return config;
            }

            
            function getGoogleDriveConfig() {
                config = {

                };
                return config;
            }


            function getHfWaitressConfig() {
                let hf_config = {
                    'model_id': document.getElementById('hf-waitress-llm-custom-dropdown-selected-value').textContent,
                    'torch_device_map': document.getElementById('hf_waitress_torch_device_map_choice').value,
                    'torch_dtype': document.getElementById('hf_waitress_torch_dtype_choice').value,
                    'use_flash_attention_2': document.getElementById('hf_waitress_use_flash_attention_2_yes').checked,
                    'trust_remote_code': document.getElementById('hf_waitress_trust_remote_code_yes').checked,
                    'awq': document.getElementById('hf_waitress_is_awq_yes').checked,
                    'pipeline_task': document.getElementById('hf_waitress_pipeline_task_choice').value,
                    'max_new_tokens': parseInt(document.getElementById('HfwMaxNewToks').value),
                    'top_k': parseInt(document.getElementById('HfwTopkSlider').value),
                    'top_p': parseFloat(document.getElementById('HfwToppSlider').value),
                    'min_p': parseFloat(document.getElementById('HfwMinpSlider').value),
                    'return_full_text': document.getElementById('hf_waitress_return_full_text_yes').checked,
                    'quantize': document.getElementById('hf_waitress_quantization_choice').value,
                    'quant_level': document.getElementById('hf_waitress_quantization_level_choice').value,
                    'hqq_group_size': parseInt(document.getElementById('HfwHqqGroupSize').value),
                    'port': parseInt(document.getElementById('HfwPort').value)
                };

                hfw_temperature = parseFloat(document.getElementById('HfwTempSlider').value);
                hf_config.do_sample = hfw_temperature > 0.0;
                hf_config.temperature = Math.max(0.0, hfw_temperature);

                if(document.getElementById('update_hf_access_token').checked) {
                    hf_config.access_gated = true;
                    hf_config.access_token = document.getElementById('hf_access_token').value;
                }

                return hf_config;
            }


            function saveConfigToServer(config) {
                return fetch('/config_writer_api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        'config_updates': config
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response.json()
                })
                .then(data => {
                    console.log(data);
                    if (data.restart_required) {    // Refresh the page
                        location.reload();
                    }
                })
                .catch(error => {
                    errorHandler("writing to config.json", "/config_writer_api", String(error.message))
                });
            }


            function handleHfWaitressChanges(hf_config) {
                return new Promise((resolve, reject) => {
                    document.getElementById('SavingHfWaitressSettings').style.display = 'block';

                    fetch('http://localhost:9069/hf_config_writer_api', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            'config_updates': hf_config
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.error) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(data);
                        if (data.restart_required) {
                            // Restart HF-Waitress Server
                            return fetch('http://localhost:9069/restart_server');
                        }
                        return { ok: true, json: () => Promise.resolve({ success: true }) };
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.error) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            document.getElementById('SavingHfWaitressSettings').style.display = 'none';
                            resolve();  // Resolve the promise when everything is done
                        } else {
                            throw new Error('Internal Server Error: Check hf_server_log and HF-Waitress command-line for more details.');
                        }
                    })
                    .catch(error => {
                        errorHandler("handling HF-Waitress Server changes", "handleHfWaitressChanges", String(error.message));
                        reject(error);  // Reject the promise if there's an error
                    })
                    .finally(() => {
                        document.getElementById('SavingHfWaitressSettings').style.display = 'none';
                    });
                });
            }


            function handleSaveChanges() {
                
                const config = {
                    ...getLlmConfig(),
                    ...getVectorEmbeddingsConfig(),
                    ...getSysPromptConfig(),
                    ...getRagConfig(),
                    ...getOcrConfig(),
                    ...getGoogleDriveConfig()
                };

                let hfSavePromise = Promise.resolve();  // Initialized as a resolved promise so non-blocking!

                if (config.local_llm_server === "hf-waitress") {
                    const hf_waitress_server_status = document.getElementById('local_llm_server_status_indicator_text').style.color;
                    if (hf_waitress_server_status === "green") {
                        const hf_config = {
                            ...getHfWaitressConfig()
                        };
                        console.log("handleHfWaitressChanges hf_config: ", hf_config);
                        hfSavePromise = handleHfWaitressChanges(hf_config)  // Added to the promise chain only if the conditions are met!
                            .then(() => {
                                console.log("HF-Waitress server changes saved successfully.");
                            })
                            .catch(error => {
                                errorHandler("saving HF-Waitress settings", "handleSaveChanges()", String(error.message));  // Catching the error will resolve the Promise and allow the rest of the code to continue!
                            });
                    }
                }
                console.log("Saving LARS config: ", config);
                Promise.all([hfSavePromise, saveConfigToServer(config)])    // This promise will always resolve, even if hfSavePromise is not resolved, so we're not blocking the saveConfigToServer() promise. Use Promise.all() to handle both promises in parallel, but wait for both to resolve before proceeding.
                    .then(() => {
                        console.log("LARS config saved successfully, restart unnecessary.");
                    })
                    .catch(error => {
                        errorHandler("saving LARS settings", "handleSaveChanges()", String(error.message));
                    });
            }

            document.getElementById('saveChangesButton').addEventListener('click', handleSaveChanges);
            //########### End SaveConfig block!


            function loadChatHistory(chatID) {

                CHAT_ID = chatID;

                document.getElementById('model_header').innerHTML = '';
                history_chat_id = chatID
                history_chat_id = " Chat ".concat(String(history_chat_id))
                display_chatid_and_model = String(history_chat_id).concat(": ", String(LLM_MODEL))
                document.getElementById('model_header').innerHTML = display_chatid_and_model;

                console.log("Loading chat history")

                document.getElementById('chat-area').innerHTML = '';

                let formData = new FormData();
                formData.append('chat_id', chatID);

                //Make a POST request to the server
                fetch('/load_chat_history', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        
                        old_chat_model = data.old_chat_model
                        old_chat_model = " Last LLM on this chat: ".concat(String(old_chat_model))
                        document.getElementById('old_model_header').innerHTML = old_chat_model;
                        document.getElementById('old_model_header').style.display = 'block';

                        chat_history_data = data.chat_history
                        console.log(data)

                        for (let i = 0; i < chat_history_data.length; i++) {
                            document.getElementById('chat-area').innerHTML += chat_history_data[i]
                        }

                        var defaultTabs = document.getElementsByClassName("defaultTabs");
                        for (let i = 0; i < defaultTabs.length; i++) {
                            defaultTabs[i].click();
                        }
                        
                    } else {
                        throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                    }
                })
                .catch(error => {
                    errorHandler("fetching chat history data", "/load_chat_history", String(error.message))
                });
                closeNav();
            }

            
            function formatTabsAndSpaces(text, tabSize = 4) {
                // Replace each tab with tabSize number of &nbsp;
                text = text.replace(/\t/g, '&nbsp;'.repeat(tabSize));

                // Replace multiple spaces (2 or more) with equivalent number of &nbsp;
                text = text.replace(/ {2,}/g, (match) => '&nbsp;'.repeat(match.length));

                // Replace newlines with <br>
                text = text.replace(/\n/g, '<br>');

                return text;
                //return "test";
            }


            function requestFormattedPrompt() {

                //Firstly, immediately disable send functionality!
                const sendButton = document.getElementById('sendButton');
                sendButton.disabled = true;

                let do_rag = true;
                let stream_session_id = "";
                let formatted_user_prompt = "";
                let llm_response = "";

                document.getElementById('processingQnS').innerHTML = 'Reading documents...';
                document.getElementById('processingQnS').style.display  = 'block';

                var userInput = document.getElementById('user-input').value;
                let userInputForHtml = formatTabsAndSpaces(userInput);

                // Clear the input field
                document.getElementById('user-input').value = '';

                // Append user input to the chat area
                document.getElementById('chat-area').innerHTML += '<div class="user-message">' + userInputForHtml + '</div>';

                document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;     //Scroll to the bottom of the page

                // AJAX call to send user query and receive the formatted prompt
                fetch('/setup_for_llama_cpp_response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({'user_query': userInput, 'chat_id': CHAT_ID})
                }).then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {

                        do_rag = data.do_rag;
                        stream_session_id = data.stream_session_id;
                        formatted_user_prompt = data.formatted_user_prompt;
                        SEQUENCE_ID = data.sequence_id;
                        
                        console.log("do_rag: ", do_rag);
                        console.log("stream_session_id: ", stream_session_id);
                        console.log("formatted_user_prompt: ", formatted_user_prompt);

                         
                        const responseWrapperID = "ResponseWrapper" + String(stream_session_id);
                        const responseContentID = "ResponseContent" + String(stream_session_id)
                        const masterWrapperID = "MasterWrapper" + String(stream_session_id);

                        document.getElementById('chat-area').innerHTML += `
                        <div class="response-and-viewer-container" id="${masterWrapperID}">
                            <div class="llm-wrapper" style="display:none;" id="${responseWrapperID}">
                            
                                <div class="llm-response" id="${responseContentID}">
                                </div>
                            </div>
                        </div>
                        `

                        let chat_container = document.getElementById('chat-area');
                        let isResponseDisplayed = false;
                        const responseContentElement = document.getElementById(responseContentID);

                        if (!isResponseDisplayed) {
                            document.getElementById('processingQnS').innerHTML = 'Generating...';
                            document.getElementById(responseWrapperID).style.display  = 'block';
                            isResponseDisplayed = true;
                        }


                        async function fetchEventStream() {
                            current_llm_server = document.getElementById('local_llm_server_select_dropdown').value;
                            
                            if (current_llm_server == 'llama-cpp') {

                                const url = "http://localhost:8080/completion";

                                const requestData = {
                                    prompt: formatted_user_prompt,
                                    stream: true,
                                    temperature: parseFloat(document.getElementById('tempSlider').value),
                                    top_k: parseInt(document.getElementById('topkSlider').value),
                                    top_p: parseFloat(document.getElementById('toppSlider').value),
                                    min_p: parseFloat(document.getElementById('minpSlider').value),
                                    n_keep: parseInt(document.getElementById('nkeepSlider').value)
                                };

                                try {

                                    const response = await fetch(url, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify(requestData)
                                    });

                                    document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;     //Scroll to the bottom of the page

                                    const reader = response.body.getReader();   // To handle the Fetch API's 'Response' object when involving a ReadableStream.  By calling getReader(), a 'ReadableStreamDefaultReader' object is obtained
                                    let totalContent = '';  //String to accumulate content
                                    let receivedComplete = false;

                                    // Function to process each text chunk
                                    async function processChunk() {
                                        let partialData = '';   // Holds partially received JSON strings

                                        while (true) {
                                            const { done, value } = await reader.read();
                                            if (done) {
                                                console.log("Stream complete");
                                                break;
                                            }

                                            const textChunk = new TextDecoder("utf-8").decode(value);   //When reading a stream with 'ReadableStreamDefaultReader', Uint8Array binary-data objects are received. TextDecoder decodes these byte streams into human readable text strings. UTF-8 encodes all possible chars in Unicode, and is the std text encoding in most network comms, thus is used here.
                                            const messages = textChunk.split('\n'); //one streamed data-message at a time, newlines are standard for seperating SSE-messages which may arrive bunched-up in chunks or partially
                                            messages.forEach(message => {

                                                if (message.startsWith('data: ')) {
                                                    const jsonStr = message.slice(6);   // remove 6 chars to get rid of the 'data: ' prefix!
                                                    try {
                                                        const dataObj = JSON.parse(jsonStr);
                                                        //console.log(dataObj.content);   // Log only the content
                                                        let streamed_content = dataObj.content.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>'); // /g - global - replace throughout string, not just the first occurance

                                                        if (!['', '<|eot_id|>', '</s>', '<|im_end|>', '<|end_of_turn|>', '<|EOT|>', '|END_OF_TURN_TOKEN|>', '<|end|>'].includes(streamed_content)) {
                                                            totalContent += streamed_content;
                                                            let tempDiv = document.createElement('div');
                                                            tempDiv.innerHTML = streamed_content;

                                                            while (tempDiv.firstChild) {
                                                                responseContentElement.appendChild(tempDiv.firstChild); // When 'appendChild' is used on an element already part of the DOM, a copy isn't created, rather it's moved to the new position thus removing that first child from tempDiv here!
                                                            }
                                                        }

                                                        const scrollThreshold = 100; //100px towards the bottom
                                                        const isNearBottom =  chat_container.scrollHeight - chat_container.clientHeight - chat_container.scrollTop < scrollThreshold;   //by calculating this way, we're finding the difference between the total height of the chat area including the invisble part that's overflown (scrollHeight), the visible height of the chat area (clientHeight), and how far down the chat area has been scrolled (scrollTop). If less than the threshold, auto-scroll engages!
                                                        // For example: if the total height is 100px(scrollHeight), 70px is visible (clientHeight), scrollTop increases as we scroll down, so it's 0 at the top and at the very bottom, scrollTop will be equal to scrollHeight - clientHeight = 30px, so the math would equal to 0px and thus within the threshold!
                                                        if (isNearBottom) {
                                                            //console.log("is scrolled to bottom")
                                                            chat_container.scrollTop = chat_container.scrollHeight;
                                                        }

                                                        if (dataObj.stop) {
                                                            receivedComplete = true;
                                                            llm_response = totalContent;
                                                            //console.log("Stop received, final content: ", totalContent);
                                                        }
                                                    } catch (error) {
                                                        console.error('Error parsing JSON: ', error);
                                                    }
                                                }
                                            });

                                            responseContentElement.innerHTML = totalContent;

                                            if (receivedComplete) break;
                                        }
                                    }

                                    await processChunk();   // processChunk() is an async-Fn and thus returns a promise. Here, via await, we pause execution until the promise is resolved or rejected.
                                } catch (error) {
                                    errorHandler("fetching event-streaming response", "localhost:8080/completions", String(error))
                                }
                            } else if (current_llm_server == 'hf-waitress') {
                                const url = "http://localhost:9069/completions_stream";

                                const hfwHeaders = new Headers();
                                hfwHeaders.append("Content-Type", "application/json");
                                hfwHeaders.append("X-Max-New-Tokens", document.getElementById('HfwMaxNewToks').value);
                                hfwHeaders.append("X-Temperature", document.getElementById('HfwTempSlider').value);
                                hfwHeaders.append("X-Top-K", document.getElementById('HfwTopkSlider').value);
                                hfwHeaders.append("X-Top-P", document.getElementById('HfwToppSlider').value);
                                hfwHeaders.append("X-Min-P", document.getElementById('HfwMinpSlider').value);
                                hfwHeaders.append("X-Do-Sample", document.getElementById('HfwTempSlider').value > 0 ? "True" : "False");
                                
                                const rawBodyJSONObj = JSON.parse(formatted_user_prompt);                                
                                const rawBodyJSONStringified = JSON.stringify(rawBodyJSONObj);

                                // console.log("rawBodyJSONObj: ", rawBodyJSONObj);
                                // console.log("rawBodyJSONStringified: ", rawBodyJSONStringified);

                                try {
                                    const hfwResponse = await fetch(url, {
                                        method: 'POST',
                                        headers: hfwHeaders,
                                        body: rawBodyJSONStringified,
                                        redirect: 'follow'
                                    });

                                    document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;     //Scroll to the bottom of the page

                                    const hfwReader = hfwResponse.body.getReader();
                                    let hfwTotalContent = '';
                                    let hfwReceivedComplete = false;

                                    async function hfwProcessChunk() {
                                        let partialHfwData = '';

                                        while (true) {
                                            const { done, value } = await hfwReader.read();
                                            if (done) {
                                                console.log("HF-Waitress Stream complete");
                                                break;
                                            }
                                            
                                            const textChunk = new TextDecoder("utf-8").decode(value);
                                            const messages = textChunk.split('\n');
                                            
                                            messages.forEach(message => {
                                                
                                                if (message.startsWith('data: ')) {
                                                    const jsonStr = message.slice(7, -1);   // remove first 7 and last 1 chars to get rid of the 'data: "' prefix and " suffix!

                                                    //console.log("message: ", message);
                                                    try {
                                                        let dataObj = String(jsonStr);
                                                        if (dataObj == "null") {
                                                            dataObj = "";
                                                        }
                                                        // console.log("dataObj: ", dataObj);
                                                        let streamed_content = dataObj.replace(/\\n\\n/g, '<br><br>').replace(/\\n/g, '<br>'); // /g - global - replace throughout string, not just the first occurance

                                                        hfwTotalContent += streamed_content;
                                                        let tempDiv = document.createElement('div');

                                                        tempDiv.innerHTML = streamed_content;

                                                        while (tempDiv.firstChild) {
                                                            responseContentElement.appendChild(tempDiv.firstChild);
                                                        }

                                                        const scrollThreshold = 100; //100px towards the bottom
                                                        const isNearBottom =  chat_container.scrollHeight - chat_container.clientHeight - chat_container.scrollTop < scrollThreshold;   //by calculating this way, we're finding the difference between the total height of the chat area including the invisble part that's overflown (scrollHeight), the visible height of the chat area (clientHeight), and how far down the chat area has been scrolled (scrollTop). If less than the threshold, auto-scroll engages!
                                                        // For example: if the total height is 100px(scrollHeight), 70px is visible (clientHeight), scrollTop increases as we scroll down, so it's 0 at the top and at the very bottom, scrollTop will be equal to scrollHeight - clientHeight = 30px, so the math would equal to 0px and thus within the threshold!
                                                        if (isNearBottom) {
                                                            //console.log("is scrolled to bottom")
                                                            chat_container.scrollTop = chat_container.scrollHeight;
                                                        }

                                                    } catch (error) {
                                                        console.error('Error parsing message: ', error);
                                                    }
                                                } else if (message.startsWith('event: END') || message.startsWith('data: null')) {
                                                    console.log("Received null message from hf-waitress - stream complete");
                                                    hfwReceivedComplete = true;
                                                    llm_response = hfwTotalContent;
                                                }
                                            });

                                            responseContentElement.innerHTML = hfwTotalContent;

                                            if (hfwReceivedComplete) break;
                                        }
                                    
                                    }

                                    await hfwProcessChunk();
                                    
                                } catch (error) {
                                    errorHandler("fetching HF-Waitress event-streaming response", "localhost:9069/completions_stream", String(error))
                                }

                            }
                        }

                        // Cannot use await here as fetchEventStream() is not within another async-Fn, but rather is the top-level async-Fn! Use .then() as with a fetch call if you must await fetchEventStream(), or else simply fire-and-forget!
                        fetchEventStream().then(() => {
                            console.log('Event stream has completed');
                            // /get_ref here!
                            console.log("llm_response post stream: ", llm_response);
                            // Having received the LLM response stream, fetch relevant pages, documents, and images, if any
                            if (do_rag) {
                                document.getElementById('processingQnS').innerHTML = 'Fetching any references...';
                            }
                            fetch('/get_references', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({'chat_id':CHAT_ID, 'sequence_id': SEQUENCE_ID, 'stream_session_id': stream_session_id, 'user_query': userInput, 'llm_response': llm_response, 'formatted_user_prompt': formatted_user_prompt})
                            }).then(response => {
                                if (!response.ok) {
                                    return response.json().then(err => { throw new Error(err.error)});
                                }
                                return response
                            })
                            .then(response => response.json())
                            .then(data => {
                                
                                if (data.success) {

                                    console.log("get_references data: ", data);

                                    if (do_rag) {
                                        document.getElementById(responseContentID).innerHTML += `
                                        </br> 
                                        ${data.response}
                                        ` 
                                    }
                                    
                                    document.getElementById(responseContentID).innerHTML += `
                                    <div class="star-rating" data-rated="False" rating-chat-id=${CHAT_ID} rating-sequence-id=${SEQUENCE_ID}>
                                        <i class="far fa-star" data-rate="1"></i>
                                        <i class="far fa-star" data-rate="2"></i>
                                        <i class="far fa-star" data-rate="3"></i>
                                        <i class="far fa-star" data-rate="4"></i>
                                        <i class="far fa-star" data-rate="5"></i>
                                    </div>
                                    `
                                    if (do_rag) {
                                        document.getElementById(masterWrapperID).innerHTML += data.pdf_frame;
                                        // Open the first tab by default
                                        var defaultTabs = document.getElementsByClassName("defaultTabs");
                                        for (let i = 0; i < defaultTabs.length; i++) {
                                            if (defaultTabs[i].getAttribute('stream-session-id') === stream_session_id) {
                                                defaultTabs[i].click();
                                            }
                                        }
                                    }
                                } else {
                                    throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                                }
                            })
                            .catch(error => {
                                errorHandler("fetching relevant reference material", "/get_references", String(error.message))
                            })
                            .finally(() => {
                                document.getElementById('processingQnS').style.display  = 'none';
                                document.getElementById('processingQnS').innerHTML = '';
                            });

                        }).catch(error => {
                            errorHandler("fetching event-streaming response", "async fetchEventStream()", String(error.message))
                        });

                    } else {
                        throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                    }
                })
                .catch(error => {
                    errorHandler("setting up the streaming response", "/setup_for_llama_cpp_response", String(error.message))
                })
                .finally(() => {
                    sendButton.disabled = false; // Re-enable the send button
                });
            }



            function sendMessageAndProcessResponseStream() {

                document.getElementById('processingQnS').innerHTML = 'Reading documents...';
                document.getElementById('processingQnS').style.display  = 'block';

                var userInput = document.getElementById('user-input').value;
                //let userInputForHtml = userInput.replace(/\n/g, '<br>');
                let userInputForHtml = formatTabsAndSpaces(userInput);
                
                // Clear the input field
                document.getElementById('user-input').value = '';

                // Append user input to the chat area
                document.getElementById('chat-area').innerHTML += '<div class="user-message">' + userInputForHtml + '</div>';

                // AJAX call to send user query and receive the response
                fetch('/setup_for_streaming_response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({'message': userInput})
                }).then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error)});
                    }
                    return response
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // At this stage, we've passed the user's query to the server and have received an stream_session ID, now we handle the stream
                        let stream_session_id = data.stream_session_id;
                        let do_rag = data.do_rag;
                        //console.log(do_rag);
                        
                        const responseWrapperID = "ResponseWrapper" + String(stream_session_id);
                        const responseContentID = "ResponseContent" + String(stream_session_id)
                        const masterWrapperID = "MasterWrapper" + String(stream_session_id);

                        document.getElementById('chat-area').innerHTML += `
                        <div class="response-and-viewer-container" id="${masterWrapperID}">
                            <div class="llm-wrapper" style="display:none;" id="${responseWrapperID}">
                            
                                <div class="llm-response" id="${responseContentID}">
                                </div>
                            </div>
                        </div>
                        `
                        let chat_container = document.getElementById('chat-area');
                        let isResponseDisplayed = false;
                        const responseContentElement = document.getElementById(responseContentID);
                        const encodedUserInput = encodeURIComponent(userInput);
                        const evtSource = new EventSource("/stream/" + stream_session_id + "?input=" + encodedUserInput);
                        evtSource.onmessage = function(event) {

                            if (!isResponseDisplayed) {
                                document.getElementById('processingQnS').innerHTML = 'Generating...';
                                document.getElementById(responseWrapperID).style.display  = 'block';
                                isResponseDisplayed = true;
                            }
                            
                            // document.getElementById(responseContentID).innerHTML += event.data;
                            
                            // 'innerHTML' is very inefficent to do repeatedly, as it doesn't simply append but rather re-parses & rebuilds the entire inner content every time! 
                            // Instead, using the DOM API as below to create & append elements is much more efficient as it manipulates the DOM by adding a new node, leaving existing nodes untouched. 
                            // This is also better from a security perspective as recreating DOM elements via innerHTML can be exploited for XSS!

                            let tempDiv = document.createElement('div');
                            tempDiv.innerHTML = event.data;

                            // streaming response from LLM starts, begin appending to chat-area
                            while (tempDiv.firstChild) {
                                //console.log("appending")
                                responseContentElement.appendChild(tempDiv.firstChild); // When 'appendChild' is used on an element already part of the DOM, a copy isn't created, rather it's moved to the new position thus removing that first child from tempDiv here!
                            }

                            // chatContainer.scrollHeight is the total height of the content within the chat container.
                            // chatContainer.clientHeight is the visible height of the chat container.
                            // chatContainer.scrollTop is the distance from the top of the chat container to the top of the visible content.
                            
                            const scrollThreshold = 100; //100px towards the bottom
                            const isNearBottom =  chat_container.scrollHeight - chat_container.clientHeight - chat_container.scrollTop < scrollThreshold;   //by calculating this way, we're finding the difference between the total height of the chat area including the invisble part that's overflown (scrollHeight), the visible height of the chat area (clientHeight), and how far down the chat area has been scrolled (scrollTop). If less than the threshold, auto-scroll engages!
                            // For example: if the total height is 100px(scrollHeight), 70px is visible (clientHeight), scrollTop increases as we scroll down, so it's 0 at the top and at the very bottom, scrollTop will be equal to scrollHeight - clientHeight = 30px, so the math would equal to 0px and thus within the threshold!
                            if (isNearBottom) {
                                console.log("is scrolled to bottom")
                                chat_container.scrollTop = chat_container.scrollHeight;
                            }
                        }
                        evtSource.onerror = function(error) {
                            console.error("EventSource failed: ", error);
                            evtSource.close();
                        }
                        evtSource.addEventListener("END", function(event) {
                            evtSource.close();

                            // Having received the LLM response stream, fetch relevant pages, documents, and images, if any
                            if (do_rag) {
                                document.getElementById('processingQnS').innerHTML = 'Fetching any references...';
                            }
                            fetch('/lc_get_references', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({'stream_session_id': stream_session_id, 'message': userInput})
                            }).then(response => {
                                if (!response.ok) {
                                    return response.json().then(err => { throw new Error(err.error)});
                                }
                                return response
                            })
                            .then(response => response.json())
                            .then(data => {
                                
                                if (data.success) {
                                    //CHAT_ID = data.chat_id;
                                    SEQUENCE_ID = data.sequence_id;

                                    if (do_rag) {
                                        document.getElementById(responseContentID).innerHTML += `
                                        </br> 
                                        ${data.response}
                                        ` 
                                    }
                                    
                                    document.getElementById(responseContentID).innerHTML += `
                                    <div class="star-rating" data-rated="False" rating-chat-id=${data.chat_id} rating-sequence-id=${data.sequence_id}>
                                        <i class="far fa-star" data-rate="1"></i>
                                        <i class="far fa-star" data-rate="2"></i>
                                        <i class="far fa-star" data-rate="3"></i>
                                        <i class="far fa-star" data-rate="4"></i>
                                        <i class="far fa-star" data-rate="5"></i>
                                    </div>
                                    `
                                    if (do_rag) {
                                        document.getElementById(masterWrapperID).innerHTML += data.pdf_frame;
                                    }

                                    document.getElementById('processingQnS').style.display  = 'none';
                                    document.getElementById('processingQnS').innerHTML = '';
                                } else {
                                    throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                                }
                            })
                            .catch(error => {
                                errorHandler("fetching relevant reference material", "/lc_get_references", String(error.message))
                            });
                        });
                    } else {
                        throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                    }
                })
                .catch(error => {
                    errorHandler("setting up for the streaming response", "/setup_for_streaming_response", String(error.message))
                });
            }


            function goToPage(iframeId, url) {
                var iframe = document.getElementById(iframeId)
                
                // Set src to blank and then to desired src to prevent the browser from ignoring clicks!
                iframe.src = 'about:blank';
                setTimeout(() => iframe.src = url, 100); // Set a slight delay to ensure the reload
            }

            function goToPageAndSwitchTab(iframeId, url, tabName, streamSessionId) {
                // First, switch to the correct tab
                openTab(null, tabName, streamSessionId);

                // Then, navigate to the correct page
                goToPage(iframeId, url);
            }


            // Call sendMessage() if the user presses the 'Enter' key
            const maxRows = 5; // Replace this value with the maximum allowed number of rows you want
            const inputTextAreaElement = document.getElementById("user-input");
            var currentRows = inputTextAreaElement.rows;

            inputTextAreaElement.addEventListener("keydown", function(event) {
                const sendButton = document.getElementById('sendButton');
                // Check if the Enter key was pressed and the input isn't empty
                if (!event.shiftKey && event.key == "Enter" && this.value.trim() !== "") {
                    // Prevent the default action (i.e., adding a new line)
                    event.preventDefault();
                    // Call the send function
                    // sendMessage()
                    if(!sendButton.disabled) {  //Only trigger a send event if the button is not disabled, i.e. another stream is in progress!
                        inputTextAreaElement.rows = 1;
                        //sendMessageAndProcessResponseStream()
                        requestFormattedPrompt();
                    }
                } else if (event.shiftKey && event.key == "Enter") {
                    if (currentRows <= maxRows) {
                        inputTextAreaElement.rows += 1;
                        currentRows += 1;
                    }
                } else if (event.keyCode === 8 || event.keyCode === 46) { //8 is Backspace and 46 is
                    //console.log("backspace or delete pressed")
                    newlineCount = inputTextAreaElement.value.split("\n").length;
                    if (newlineCount < currentRows) {
                        //console.log("trimming rows")
                        inputTextAreaElement.rows = newlineCount;
                        currentRows = newlineCount;
                    }
                }
            });

            
            function adjustTextareaRows() {
                newlineCount = inputTextAreaElement.value.split("\n").length;
                if (newlineCount < maxRows) {
                    inputTextAreaElement.rows = newlineCount;
                    currentRows = newlineCount;
                } else if (newlineCount >= maxRows) {
                    inputTextAreaElement.rows = maxRows;
                    currentRows = newlineCount;
                }
            }
            document.getElementById("user-input").addEventListener('input', adjustTextareaRows);
            document.getElementById("user-input").addEventListener('change', adjustTextareaRows);


            // Upload new files to VectorDB
            document.getElementById('fileInput').addEventListener('change', function (event) {
                if (this.value) {    // Check if a file is selected
               
                    document.getElementById('overlay').style.display = 'block';
                    
                    let newFile = document.getElementById('fileInput');
                    let file = newFile.files[0]

                    if (file) {
                        let formData = new FormData();
                        formData.append('file', file);

                        // Make the AJAX request to the server
                        fetch('/process_new_file', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(err => { throw new Error(err.error)});
                            }
                            return response
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                populateDocsLoadedTable();
                                document.getElementById('overlay').style.display = 'none';
                                document.getElementById('fileInput').value = "";  // Clear the input value
                            } else {
                                throw new Error(`Internal Server Error: Check server-log and server command-line for more details.`);
                            }
                        })
                        .catch(error => {
                            errorHandler("processing file", "/process_new_file", String(error.message))
                            document.getElementById('overlay').style.display = 'none';
                            document.getElementById('fileInput').value = "";  // Clear the input value
                        });
                    }
                }    
            });


            function handleUploadError(errorMessage) {
                console.error('Error uploading file:', errorMessage);
                alert("Error when trying to upload new LLM to models dir. Check console for more details.");
                cleanupUpload();
            }

            function cleanupUpload() {
                document.getElementById('UploadingLlmOverlay').style.display = 'none';
                document.getElementById('uploadLlm').value = "";  // Clear the input value
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('progressPercentage').textContent = '0%';
            }

            // Upload LLMs to '/models' dir
            document.getElementById('uploadLlm').addEventListener('change', function (event) {
                if (this.value) {    // Check if a file is selected

                    document.querySelector('.btn-close[data-bs-dismiss="modal"]').click();
                    document.getElementById('UploadingLlmOverlay').style.display = 'block';
                    document.getElementById('uploadProgress').style.display = 'block';
                    
                    let newFile = document.getElementById('uploadLlm');
                    let file = newFile.files[0]

                    if (file) {
                        let formData = new FormData();
                        formData.append('file', file);

                        let xhr = new XMLHttpRequest();
                        xhr.open('POST', '/upload_new_llm', true);

                        xhr.upload.onprogress = function(e) {
                            if (e.lengthComputable) {
                                let percentComplete = (e.loaded / e.total) * 100;
                                document.getElementById('progressPercentage').textContent = percentComplete.toFixed(2) + '%';
                            }
                        };

                        xhr.onload = function() {
                            if (xhr.status === 200) {
                                let response;
                                try {
                                    response = JSON.parse(xhr.responseText);
                                } catch(e) {
                                    handleUploadError('Invalide JSON response from server');
                                    return;
                                }
                                
                                if (response.success) {
                                    
                                    const initKeysToRead = ['model_choice']
                                    fetch('/config_reader_api', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({keys: initKeysToRead})
                                    })
                                    .then(response => {
                                        if (!response.ok) {
                                            return response.json().then(err => { throw new Error(err.error)});
                                        }
                                        return response
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        var values = data.values;
                                        var model_choice = values.model_choice;

                                        fetch('/load_local_models')
                                        .then(response => {
                                            if (!response.ok) {
                                                return response.json().then(err => { throw new Error(err.error)});
                                            }
                                            return response
                                        })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.success) {

                                                const dropdown = document.getElementById('modelDropdown');
                                                dropdown.innerHTML = '';
                                                data.models.forEach(model => {
                                                    const option = document.createElement('option');
                                                    option.value = model;
                                                    option.textContent = model;
                                                    //console.log('Model:', model);

                                                    if (typeof model !== 'undefined' && typeof model_choice !== 'undefined') {
                                                        if (model.toLowerCase() == model_choice.toLowerCase()) {
                                                            option.selected = true;
                                                        }
                                                    }
                                                    dropdown.appendChild(option);
                                                });

                                                cleanupUpload();
                                            
                                            } else {
                                                throw new Error('Internal Server Error: Check server-log and server command-line for more details.');
                                            }
                                        })
                                        .catch(error => {
                                            handleUploadError(`There was an error in fetching the model list: ${error.message}`)
                                        }); // END load_local_models

                                    })
                                    .catch(error => {
                                        handleUploadError(`There was an error in reading config.json: ${error.message}`)
                                    }); //END config_reader_api call

                                } else {
                                    handleUploadError('Server-side response indicates failure')
                                }
                            } else {
                                    handleUploadError(`Non-200 response: ${xhr.status} ${xhr.statusText}`);
                                }
                        };

                        xhr.onerror = function() {
                            handleUploadError('Network error occured - xhr.onerror() triggered')
                        };

                        xhr.send(formData);

                    }
                }
            });


            // Store user rating & update UI - confirm the associated route does not contain print() statements as the stdout is redirected during response generation!
            document.getElementById('chat-area').addEventListener('click', function(e) {
                if(e.target.classList.contains('fa-star')) {
                    let starContainer = e.target.parentElement;
                    if(starContainer.getAttribute('data-rated') === "False") {
                        
                        let rate = e.target.getAttribute('data-rate');
                        let chat_id = starContainer.getAttribute('rating-chat-id');
                        let sequence_id = starContainer.getAttribute('rating-sequence-id');

                        for(let i = 0; i < rate; i++) {
                            console.log("filling star-rating")
                            starContainer.children[i].classList.remove('far');
                            starContainer.children[i].classList.add('fas'); // This fills the star
                        }
                        starContainer.setAttribute('data-rated', "True");
                        
                        let formData = new FormData();
                        formData.append('rating', rate);
                        formData.append('chat_id', chat_id);
                        formData.append('sequence_id', sequence_id);
                        // AJAX time:
                        fetch('/store_user_rating', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(err => { throw new Error(err.error)});
                            }
                        })
                        .catch(error => {
                            errorHandler("storing the user's rating", "/store_user_rating", String(error.message))
                        });
                    }
                }
            });


            function toggleInfo() {
                var infoBox = document.getElementById('info_box');
                if (infoBox.style.display === 'none') {
                    infoBox.style.display = 'block';
                } else {
                    infoBox.style.display = 'none';
                }
            }

        </script>

    </body>

</html>